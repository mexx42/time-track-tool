<tal:block metal:define-macro="edit_leave_submission">
 <tal:block tal:define="
   pdict python:dict ((x._name, x) for x in db.leave_submission.properties ());
   props python:
    ( utils.ExtProperty
        ( utils, pdict ['user']
        , fieldwidth  = 12
        )
    , utils.ExtProperty
        ( utils, pdict ['first_day']
        , fieldwidth  = 12
        , popcal      = False
        , format      = utils.ymd
        )
    , utils.ExtProperty
        ( utils, pdict ['last_day']
        , fieldwidth  = 12
        , popcal      = False
        , format      = utils.ymd
        )
    , utils.ExtProperty
        ( utils, pdict ['time_wp']
        , additional  = ['project']
        , filter      = dict
           (id = utils.valid_leave_wps (db._db, user = db._db.getuid ()))
        )
    , utils.ExtProperty
        ( utils, pdict ['status']
        , multiselect = True
        )
    );
    buttons python: utils.Leave_Buttons (db)
   "
   tal:condition="context/is_view_ok">
  <tal:block tal:condition="context/is_view_ok">
   <form method="POST" onsubmit="return submit_once()"
         enctype="multipart/form-data" action="leave_submission"
         name="edit_leave_submission">
    <input type="hidden" name="@action"   value="edit">
    <input type="hidden" name="@template" tal:attributes="value tplname">
    <table class="list" border="1">
     <tr>
      <tal:block tal:repeat="prop python:props [not do_user:]">
       <th tal:content="python: prop.i18nlabel" />
      </tal:block>
      <th i18n:translate="">Days</th>
      <th i18n:translate="">Action</th>
     </tr>
     <tal:block tal:repeat="i batch">
      <tal:block
       tal:define="sideffect python:props [0].menu_or_field (item = i)" />
      <tr tal:attributes="class python:['normal', 'alt'][repeat['i'].index%2]">
       <tal:block tal:repeat="prop python:props [not do_user:]">
        <tal:block tal:define="edit python:
             i.status.plain () == 'open' and prop.name != 'status'">
         <td tal:content="structure python:prop.menu_or_field
                 (item = i, editable = edit)"/>
        </tal:block>
       </tal:block>
       <td tal:content="python:utils.leave_days
           ( db._db
           , props [0].prop.id
           , props [1].prop._value
           , props [2].prop._value
           )"/>
       <td tal:content="structure python: buttons.generate (props [4])"/>
      </tr>
     </tal:block>
    </table>
   </form>
  </tal:block>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="editform">
 <tal:block tal:define=
   " use_labelprop python:0
   ; required_attributes python:
     'first_day,last_day' + [',user',''][bool (context.id or not show_user)]
   ">
  <tal:block metal:use-macro="templates/page/macros/formatted_class">
   <tal:block metal:fill-slot="formatted_class_content">
    <tr tal:condition="show_user">
     <th tal:content="structure python:utils.fieldname (classname, 'user')"
         tal:attributes="class python: ['required',''][bool (context.id)]"/>
     <tal:block tal:condition="python: not context.id">
      <td>
       <span tal:content="structure python:context.user.field ()" />
       <span tal:replace="structure python:db.user.classhelp
             ( utils.user_props (db)
             , property='user'
             , inputtype='radio'
             , width='600'
             , filter='status=%s' % db._db.user_status.lookup ('valid')
             , pagesize=500
             )"/>
      </td>
     </tal:block>
     <td tal:condition="python: context.id"
         tal:content="structure python:context.user.plain ()" />
    </tr>
    <tr>
     <th tal:content="structure python:utils.fieldname
         (classname, 'first_day')" class="required"/>
     <td tal:content="structure python:context.first_day.field
         (12, popcal = True, format = utils.ymd)"/>
     <th tal:content="structure python:utils.fieldname
         (classname, 'last_day')" class="required"/>
     <td tal:content="structure python:context.last_day.field
         (12, popcal = True, format = utils.ymd)"/>
    </tr>
    <tr tal:condition="context/id">
     <th i18n:translate="">Days</th>
     <td tal:content="python: utils.leave_days
         ( db._db
         , context.user.id
         , context.first_day._value
         , context.last_day._value
         )"/>
    </tr>
    <tr>
     <th tal:content="structure python:utils.fieldname
         (classname, 'time_wp')"/>
     <td tal:content="structure python:context.time_wp.menu
        ( additional = ['project']
        , id = utils.valid_leave_wps (db._db, user = user)
        ) "/>
     <th tal:condition="python: context.id"
         tal:content="structure python:utils.fieldname (classname, 'status')"/>
     <td tal:condition="python: context.id"
         tal:content="structure python:context.status.menu ()"/>
     <td tal:condition="python: not context.id"
         tal:content="structure python:context.status.plain ()"/>
    </tr>
    <tr><td>&nbsp;</td></tr>
    <tr tal:define="remdate python:utils.remaining_until (db)">
     <th i18n:translate="">Remaining Vacation
      <span tal:content="python:remdate.pretty (utils.ymd)"/>
      &nbsp;
     </th>
     <td tal:content="python:utils.remaining_vacation
         (db._db, db._db.getuid (), date = remdate)"/>
    </tr>
   </tal:block>
  </tal:block>
 </tal:block>
</tal:block>
