<tal:block metal:define-macro="icing">
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
                               "http://www.w3.org/TR/html4/strict.dtd">
<html tal:define="
   uname         python:str(request.user.username)
 ; qname_form    request/form/queryname/value | python:''
 ; qname_request python:(('queryname' in dir(request)) and request.queryname) or ''
 ; qname_f       python:((qname_form   [:len(uname)]==uname) and (qname_form   [(len(uname)+1):])) or (qname_form)
 ; qname_r       python:((qname_request[:len(uname)]==uname) and (qname_request[(len(uname)+1):])) or (qname_request)
 ; qname         python:qname_r or qname_f
 ; classname     context/_classname|db/address/_classname
 ; Classname     python: i18n.gettext (classname)
 ; klass         python:db [classname] or default
 ; has_msgs      python:'messages' in klass._klass.getprops ()
 ; has_invoices  python:'invoices' in klass._klass.getprops ()
 ; has_letters   python:'letters'  in klass._klass.getprops ()
 ; is_user       python:uname!='anonymous'
 ; tplate_args   python:{}
 ; default_query python:{ 'abo'     : '%3Aaction=search&%3Astartwith=0&%3Apagesize=20&%3Asort=id&%3Asortdir=on&%3Agroup=&%3Acolumns=id&%3Acolumns=aboprice&%3Acolumns=amount&%3Acolumns=begin&%3Acolumns=end&%3Acolumns=subscriber&%3Acolumns=payer&aboprice=&%3Asearch_text=&%40queryname=&id=&amount=&begin=&end='
                        , 'address' : '@action=search&:startwith=0&:pagesize=20&:sort=id&:sortdir=on&:group=&:columns=salutation&:columns=title&:columns=id&:columns=lastname&:columns=firstname&valid=1&:search_text=&@queryname='
                        , 'abo_price': ''
                        , 'abo_type': ''
                        , 'adr_type_cat': ''
                        , 'adr_type' : '%3Aaction=search&%3Astartwith=0&%3Apagesize=50&%3Asort=&%3Agroup=&%3Acolumns=id&%3Acolumns=code&%3Acolumns=description&%3Acolumns=typecat&typecat=19&typecat=6&typecat=16&typecat=5&typecat=3&typecat=7&typecat=14&typecat=10&typecat=1&typecat=12&typecat=4&typecat=15&typecat=17&typecat=8&typecat=9&typecat=2&typecat=11&typecat=13&typecat=18&%3Asearch_text=&%40queryname=&id=&name=&description='
                        , 'currency': ''
                        , 'invoice' : '%3Aaction=search&%3Astartwith=0&%3Apagesize=50&%3Asort=period_start&%3Asortdir=on&%3Agroup=&%3Acolumns=id&%3Acolumns=invoice_no&%3Acolumns=period_start&%3Acolumns=period_end&%3Acolumns=amount&%3Acolumns=currency&%3Acolumns=balance_open&%3Acolumns=open&%3Acolumns=n_sent&%3Acolumns=send_it&%3Acolumns=last_sent&%3Acolumns=date_payed&%3Acolumns=bookentry&%3Acolumns=receipt_no&%3Acolumns=payer&%3Acolumns=subscriber&%3Acolumns=abo&currency=&%3Asearch_text=&%40queryname=&id=&invoice_no=&period_start=&period_end=&amount=&balance_open=&open=1&n_sent=&send_it=&last_sent=&date_payed=&bookentry=&receipt_no='
                        , 'invoice_group' : ''
                        , 'invoice_template' : ''
                        , 'tmplate' : ''
                        , 'valid': ''
                        }
 ">
 <head>
  <title metal:define-slot="head_title">Welcome</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8;">
  <link rel="stylesheet" type="text/css" href="@@file/style.css">
  <script tal:replace="structure request/base_javascript"></script>
 </head>
 <body class="body">
  <table class="body" tal:condition="not:is_user" align="center" valign="middle">
   <tr>
<!-- login -->
    <td>
<form method="POST" name="login_form" tal:attributes="action request/base">
     <table class="form">
      <tr>
       <td colspan="2" align="center">Willkommen zur<br>Abonnentenverwaltung<br>
          <font size="-2"><b>Cookies</b> und <b>JavaScript</b> m√ºssen eingeschaltet sein.</font></td>
      </tr>
      <tr>
       <th>Login:</th>
       <td><input size="10" name="__login_name"></td>
      </tr>
      <tr>
       <th>Passwort:</th>
       <td><input size="10" type="password" name="__login_password"></td>
      </tr>
      <tr>
       <td colspan="2" align="center">
        <input type="submit" name="@action" value="Login">
<!-- XXX: needs some cleanup in this logic and also in the referring template
        <a href="user?@template=forgotten">Forgot your password?</a>
-->
       </td>
      </tr>
     </table>
     <script language="javascript">
     <!--
       document.login_form.__login_name.focus ();
       document.login_form.__login_name.select ();
     -->
     </script>
</form>
    </td>
   </tr>
  </table>

<!-- menubar -->
<form name="menubar">
  <table bgcolor="#eeeeee" tal:condition="is_user">
   <tr>
    <td tal:condition="python:1" class="sidebar" nowrap>
      <span class="classblock">
       <select name="query"
        onChange="javascript:document.location=document.forms['menubar'].elements['query'].options[document.forms['menubar'].elements['query'].options.selectedIndex].value; ">

        <option value="query?@template=edit">-- Abfragen --</option>
        <tal:block
         tal:define="klasses python:
          [ ('abo',              'View', (('',''),))
          , ('address',          'View', (('',''),))
          , ('invoice',          'Edit', (('generate invoices', 'send'),('','')))
          , ('adr_type',         'View', (('',''),))
          , ('adr_type_cat',     'Edit', (('',''),))
          , ('abo_type',         'Edit', (('',''),))
          , ('currency',         'Edit', (('',''),))
          , ('abo_price',        'Edit', (('',''),))
          , ('valid',            'Edit', (('',''),))
          , ('invoice_group',    'Edit', (('',''),))
          , ('invoice_template', 'Edit', (('',''),))
          ]"
         tal:repeat="kp klasses"
        >
         <tal:block
          tal:define="
              klassname python: kp [0]
            ; perm      python: kp [1]
            ; tplates   python: kp [2]
            "
          tal:condition="python:request.user.hasPermission (perm,klassname)">
          <tal:block metal:use-macro="templates/page/macros/query_list"/>
         </tal:block>
        </tal:block>
       </select>
       <!--
       <input type="button" value="!" href="#" onClick="javascript:document.location=document.forms['menubar'].elements['query'].options[document.forms['menubar'].elements['query'].options.selectedIndex].value; ">
       -->
      </span>
    </td>
    <td class="sidebar">

     <!-- custom classes with "New" Button -->
     <tal:block tal:repeat="c python:['abo','address','tmplate']">
        <tal:block tal:condition="python:request.user.hasPermission('View', c)">
         <span class="classblock">
          <a tal:condition="python:request.user.hasPermission('View', c) or
                                   request.user.hasPermission('Edit', c)"
             tal:attributes="href python:'%s?%s' % (c, default_query [c])"
             tal:content="python:i18n.gettext (c)">xyzzy</a>
          <span
            tal:condition="python:request.user.hasPermission('Edit', c)"
          >
             /
             <a tal:attributes="href string:${c}?:template=item">Neu</a>
          </span>
         </span>
        </tal:block>
     </tal:block>

     <!-- user list -->
     <span class="classblock">
         <a tal:condition="python:request.user.hasPermission('View', 'user')
                                  or request.user.hasPermission('Edit', 'user')"
            href="user" >User</a>
         <span
          tal:condition="python:request.user.hasPermission('Edit', 'user')"
         >
             / <a href="user?:template=item">Neu</a></span>
     </span>

     <!-- other custom classes with special template -->
     <tal:block tal:repeat="c python:[('invoice','send')]">
        <tal:block
         tal:condition="python:request.user.hasPermission('Edit', c [0])">
         <span class="classblock">
          <a tal:condition="python:request.user.hasPermission('Edit', c [0])"
             tal:attributes=
              "href python:'%s?%s&@template=%s' %
                (c [0], default_query [c [0]], c [1])"
             tal:content="python:i18n.gettext (c [0])">xyzzy</a>
         </span>
        </tal:block>
     </tal:block>


     <!-- username -> link to own profile -->
     <span class="classblock">
      <a tal:attributes="href string:user${request/user/id}"
         tal:content="string:${request/user/username}"></a>
     </span>

<!-- logout -->
     <span class="classblock">
      <a tal:attributes="href python:request.indexargs_href('',
          {'@action':'logout'})">Logout</a>
     </span>
    </td>
   </tr>
   <tr tal:condition="python:False">
     <td class="sidebar" colspan="2">
     <!-- custom classes -->
        <tal:block tal:repeat="c python:
          ['abo_type','currency','abo_price'
          ,'valid','invoice_template'
          ]">
         <tal:block
          tal:condition="python:request.user.hasPermission('View', c)">
          <span class="classblock">
           <a tal:condition="python:request.user.hasPermission('View', c) or
                                    request.user.hasPermission('Edit', c)"
              tal:attributes="href python:'%s?%s' % (c, default_query [c])"
              tal:content="python:i18n.gettext (c)">xyzzy</a>
          </span>
         </tal:block>
        </tal:block>

     <!-- custom classes with "New" Button -->
     <tal:block tal:repeat="c python:['tmplate']">
        <tal:block tal:condition="python:request.user.hasPermission('View', c)">
         <span class="classblock">
          <a tal:condition="python:request.user.hasPermission('View', c) or
                                   request.user.hasPermission('Edit', c)"
             tal:attributes="href python:'%s?%s' % (c, default_query [c])"
             tal:content="python:i18n.gettext (c)">xyzzy</a>
          <span
            tal:condition="python:request.user.hasPermission('Edit', 'user')"
          >
             /
             <a tal:attributes="href string:${c}?:template=item">Neu</a>
          </span>
         </span>
        </tal:block>
     </tal:block>

   </tr>

   <tal:block metal:define-slot="menu_slot" />

  </table>
</form>

<!-- body_title -->
  <tal:block tal:condition="is_user">
   <h3><span metal:define-slot="body_title"></span></h3>
  </tal:block>

<!-- errors --->
  <p tal:condition = "options/error_message | nothing"
     class         = "error-message"
     tal:repeat    = "m options/error_message"
     tal:content   = "structure m">error</p>
  <p tal:condition = "options/ok_message | nothing"
     class         = "ok-message"
     tal:repeat    = "m options/ok_message"
     tal:content   = "structure m">error</p>

<!-- page content -->
  <tal:block tal:condition="is_user">
   <span class="content" metal:define-slot="content"></span>
  </tal:block>

<!-- debug output -->
 <pre tal:condition="request/form/debug | nothing" tal:content="request"></pre>
 </body>
</html>
</tal:block>

<!-- list of queries - needs 'klassname', 'name' and 'default_query' defined -->
<tal:block metal:define-macro="query_list">
 <tal:block tal:repeat="t tplates">
 <tal:block
  tal:define=" name      python:i18n.gettext (t [0] or klassname)
             ; tplate    python: ('&@template=%s' % t [1], '') [not t [1]]">
   <option tal:attributes="
    value python:'%s?%s%s' % (klassname, default_query [klassname], tplate)"
    tal:content="name"></option>
  </tal:block>
 </tal:block>
 <option tal:define="queries python:db.query.filter(filterspec={'private_for':None, 'klass':klassname})"
  tal:repeat="q queries"
  tal:attributes="value string:${klassname}?@template=index&@queryname=${q/name}&queryid=${q/id}&${q/url}"
  tal:content="structure string:&nbsp;&nbsp;${q/name}"
 >&nbsp; &nbsp; Global Queries</option>
 <option tal:define="queries python:db.query.filter(filterspec={'private_for':request.user.id, 'klass':klassname})"
  tal:repeat="q queries"
  tal:attributes="value string:${klassname}?@template=index&@queryname=${q/name}&queryid=${q/id}&${q/url}"
  tal:content="structure string:&nbsp;&nbsp;&nbsp;&nbsp;${q/name}"
 >&nbsp; &nbsp; My Queries</option>
</tal:block>


<!-- the following macro is used for all pages which display a
     class that needs some more formatting -->

<td metal:define-macro="formatted_class">
<form method="POST"
      onSubmit="return submit_once()"
      name="itemSynopsis"
      enctype="multipart/form-data"
      tal:attributes="action context/designator">

 <input type="hidden" name="@template" value="item">

 <table class="form">

  <tal:block metal:define-slot="formatted_class_content"></tal:block>

  <tr tal:condition="has_msgs">
   <th tal:content="structure python:utils.fieldname(classname, 'msg')" />
   <td colspan="3">
    <textarea tal:content="request/form/@note/value | default"
              name="@note"
              wrap="hard"
              rows="4"
              cols="80"></textarea>
   </td>
  </tr>

  <tr>
   <th></th>
   <td colspan="3">
    <tal:block tal:replace="structure context/submit"
     tal:condition="context/is_edit_ok"/>
    <input type="button" tal:condition="context/id"
     tal:attributes=
      "onClick string:javascript:help_window('${context/designator}?@template=history','600','300')"
     value="history" i18n:attributes="value"
    >
   </td>
  </tr>

  <tr tal:condition="has_invoices">
   <th style="text-align:left" class="required"
    tal:content="structure python:utils.fieldname(classname, 'invoices')"
    tal:condition="context/invoices" />
  </tr>
  <tal:block tal:repeat="inv context/invoices/reverse"
       tal:condition="has_invoices">
   <tr>
    <th tal:content="structure python:utils.fieldname ('invoice','invoice_no')"></th>
    <td tal:content="structure python:''.join
        (( utils.ExtProperty
           (utils, inv.invoice_no, item = inv).as_listentry ()
        ,
        ))">
    </td>
    <th tal:content="structure python:utils.fieldname ('invoice','period', 'period_start')"></th>
    <td tal:content="structure python:''.join
        (( utils.ExtProperty
           (utils, inv.period_start, item = inv).as_listentry ()
        , '-'
        ,  utils.ExtProperty
           (utils, inv.period_end,   item = inv).as_listentry ()
        ))">
    </td>
   </tr>
  </tal:block>

  <tr tal:condition="python:has_letters and context.letters">
   <th style="text-align:left" class="required" tal:content="structure python:utils.fieldname (classname, 'letters')" />
  </tr>
  <tal:block tal:repeat="ltr context/letters/reverse"
       tal:condition="has_letters">
   <tr>
    <th tal:content="structure python:utils.fieldname ('letter','date')"></th>
    <td tal:content="structure python:''.join
        (( utils.ExtProperty
           (utils, ltr.date,    item = ltr, is_label = 1).as_listentry ()
         , '&nbsp;'
         , '--'
         , '&nbsp;'
         , utils.letter_link (request, ltr.id)
        ))">
    </td>
    <th tal:content="structure python:utils.fieldname ('letter', 'subject')"></th>
    <td tal:content="structure python:''.join
        ((  utils.ExtProperty
           (utils, ltr.subject, item = ltr, is_label = 1).as_listentry ()
         ,
        ))">
    </td>
   </tr>
  </tal:block>

 </table>

 <p tal:condition="context/id">
  <tal:block tal:content="structure python:''.join
   (('Angelegt <b>'
   , str (context.creation.pretty ('%Y-%m-%d'))
   , '</b> von <b>'
   , str (context.creator)
   , '</b>, '
   , i18n.gettext ('changed')
   , ' <b>'
   , str (context.activity.pretty ('%Y-%m-%d'))
   , '</b> von <b>'
   , str (context.actor)
   , '</b>,'
   ))">
  </tal:block>
 </p>

</form>

 <table class="form" tal:condition="not:context/id">
 <tr>
  <td i18n:translate="">Note:&nbsp;</td>
  <th class="required" i18n:translate="">highlighted</th>
  <td i18n:translate="">&nbsp;fields are required.</td>
 </tr>
 </table>

 <table class="messages" tal:condition="has_msgs">
  <tr>
   <th colspan="4" class="header" i18n:translate="">Messages</th>
  </tr>
  <tal:block tal:repeat="msg context/messages/reverse">
  <tr>
   <th><a tal:attributes="href string:msg${msg/id}"
          tal:content="string:msg${msg/id}"></a>
   </th>
   <th tal:content="structure python:utils.ExtProperty
       (utils, msg.author, item = msg).colonfield ()"></th>
   <th tal:content="structure python:utils.ExtProperty
       (utils, msg.date, item = msg).colonfield ()"></th>
   <th><a tal:attributes= "href
          string:${classname}${context/id}?:remove:messages=${msg/id}&:action=edit"
          i18n:translate="">remove</a>
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre tal:content="structure msg/content/hyperlinked">content</pre>
   </td>
  </tr>
  </tal:block>
 </table>
</td>

<!-- the following lists a nice list of files plus file upload form -->
<tal:block metal:define-macro="issue_files">
 <!-- list of files -->
 <table class="files" tal:condition="context/files">
  <tr>
   <th i18n:translate="">filename</th>
   <th i18n:translate="">changed</th>
  </tr>
  <tr tal:repeat="file context/files">
   <td>
    <a tal:attributes="href file/download_url"
       tal:content="file/name">dld link</a>
   </td>
   <td>
    <span tal:content="file/creator">creator's name</span>,
    <span tal:content="file/creation">creation date</span>
   </td>
  </tr>
 </table>
 <!-- add new file -->
 <input type="file" name="@file" size="40">
</tal:block>

<tal:block metal:define-macro="ttt_issue_pdf_files">
 <!-- list of files -->
 <table class="files" tal:condition="context/files">
  <tr>
   <th>File name</th>
   <th>Uploaded</th>
   <th>Type</th>
  </tr>
  <tr tal:repeat="file context/files">
   <td>
    <a tal:attributes="href file/download_url"
       tal:content="file/name">dld link</a>
   </td>
   <td>
    <span tal:content="file/creator">creator's name</span>,
    <span tal:content="file/creation">creation date</span>
   </td>
   <td tal:content="file/type" />
  </tr>
 </table>
 <!-- add new file -->
 <input type="file" name="pdf_file-1@content" size="40">
 <input type="hidden" name="@link@files" value="pdf_file-1">
</tal:block>


<!-- the following is used to have those nifty index/search form on one page -->

<tal:block metal:define-macro="ttt_search_nav">
<!-- previous / next links -->
   <tr>
    <th tal:attributes="colspan python:len(request.columns)">
     <table width="100%">
      <tr class="navigation">
       <th class="left">
        <a tal:define="prev batch/previous"
           tal:condition="prev"
           tal:attributes="href python:request.indexargs_url
             (classname
             , dict
                ( tplate_args.items ()
                + [(':startwith',prev.first) , (':pagesize',prev.size)]
                )
             )"
           i18n:translate="">&lt;&lt;&nbsp;previous
        </a>
       </th>
       <th>
        <nobr i18n:translate="">
            showing <span tal:replace="python:batch.start" i18n:name="start" />
            - <span tal:replace="python:batch.start + batch.length - 1"
                    i18n:name="end" />
            of <span tal:replace="python:batch.sequence_length"
                     i18n:name="length" /> in total
        </nobr>
       </th>
       <th class="right">
        <a tal:define="next batch/next"
           tal:condition="next"
           tal:attributes="href python:request.indexargs_url
             ( classname
             , dict
                ( tplate_args.items ()
                + [(':startwith',next.first) , (':pagesize',next.size)]
                )
             )"
           i18n:translate="">next&nbsp;&gt;&gt;</a></th>
      </tr>
     </table>
    </th>
   </tr>
</tal:block>

<tal:block metal:define-macro="search_display">
 <tal:block tal:condition="not:context/is_view_ok">
  You are not allowed to view this page.
 </tal:block>

 <tal:block tal:define="batch request/batch"
            tal:condition="context/is_view_ok">
  <table class="list" border=1>
   <tr>
<!-- list all properties we want to see -->
    <tal:block tal:repeat="prop props">
     <th tal:condition="python:request.show[prop.selname]"
         tal:content="python:prop.label">
     </th>
    </tal:block>
   </tr>
   <tal:block metal:use-macro="templates/page/macros/ttt_search_nav"></tal:block>
   <!-- items found -->
   <tal:block tal:repeat="i batch">
    <tr tal:condition="python:request.group[1] and
                              batch.propchanged(request.group[1])">
     <th tal:attributes="colspan python:len(request.columns)"
         tal:content="python:i[request.group[1]]" class="group">
     </th>
    </tr>
    <tr tal:attributes="class python:['normal', 'alt'][repeat['i'].index%2]">
     <!-- all the properties: label property and id will be made a link -->
     <tal:block tal:repeat="prop props">
      <td tal:condition="python:request.show [prop.selname]"
          tal:content="structure python:prop.as_listentry (i)">
      </td>
     </tal:block>
    </tr>
   </tal:block>
  </table>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="search_form">
<!-- query specification form -->
<form method="GET"
      name="query"
      tal:define="
       filtered_props python: [p for p in props
                               if not p.lnkattr or not '.' in p.lnkname];
       multi_props    python: [p for p in filtered_props if p.multiselect];
       sort_props     python: [p for p in props if p.sortable ()];
       nomulti_props  python: [p for p in filtered_props
                               if not p.multiselect and p.searchable]
      "
      tal:attributes="action request/classname"
      onSubmit="javascript:if (document.forms['query'].elements[':queryname'].checked==true)
               { document.forms['query'].elements[':queryname'].value = document.forms['query'].elements[':queryname'].value + document.forms['query'].elements['queryname'].value; }">
<!-- no need for "structure python:request.indexargs_form(..." all other
     values are set via the search form below, only "startwidth" should be
     set magically ...
    <tal:block tal:replace="structure python:request.indexargs_form(sort=0, group=0, filter=1, filterspec=1, columns=0, pagesize=0, ignore={'filter':'status', 'filterspec':'status'})">
    </tal:block>
 -->
  <input type="hidden" name=":action" value="search">
  <input type="hidden" name=":startwith" tal:attributes="value request/startwith">
  <table border="0" bgcolor="#e0c0c0">
   <tr>
    <th bgcolor="#C08080">
     <tal:block metal:define-slot="query_title">Current Query Specification</tal:block>:
    </th>
   </tr>

   <tr>
    <td>
     Anzeigen:
     <input type="text" size="4" name=":pagesize"
            tal:attributes="value request/pagesize"> pro Seite,
      Sortierung:<select name=":sort"
                      onChange="this.form.elements[':startwith'].value='0'">
         <option value="">- keine -</option>
         <option tal:repeat="prop sort_props"
                 tal:attributes="selected python:prop.name==request.sort[1];
                                 value    python:prop.name"
                 tal:content="python:prop.label"
         ></option>
        </select>
        Absteigend:<input type="checkbox"
                          name=":sortdir"
                          onChange="this.form.elements[':startwith'].value='0'"
                          tal:attributes="checked python:request.sort[0] == '-'">
     - Gruppierung:<select name=":group"
                        onChange="this.form.elements[':startwith'].value='0'">
         <option value="">- keine -</option>
         <option tal:repeat="prop sort_props"
                 tal:attributes="selected python:prop.name==request.group[1];
                                 value    python:prop.name"
                 tal:content="python:prop.label"
         ></option>
        </select>
        Absteigend:<input type="checkbox"
                          name=":groupdir"
                          onChange="this.form.elements[':startwith'].value='0'"
                          tal:attributes="checked python:request.group[0] == '-'">
    </td>
   </tr>

   <tr>
    <td>
     <table border="0" bgcolor="#e0c0c0">
      <!-- fill in custom query data -->
      <!-- fill in multi selection boxes -->
      <tr>
        <th style="text-align:left;">Felder:</th>
       <tal:block tal:repeat="prop multi_props">
        <th style="text-align:left;" tal:content="python:prop.label+':'"></th>
       </tal:block>
      </tr>

      <tr>
       <!-- View -->
       <td style="text-align:center;">
        <select multiple name=":columns" size="7">
         <option tal:repeat="prop filtered_props"
                 tal:attributes="selected python:request.show[prop.selname];
                                 value    python:prop.selname"
                 tal:content="python:prop.label"></option>
        </select>
       </td>
       <tal:block tal:repeat="prop multi_props">
        <td style="text-align:center;">
         <select multiple
                 size="7"
                 tal:attributes="name python:prop.name"
                 tal:define="form_vals
                   python:request.filterspec.get(prop.name) or []">
          <option value=""
                  tal:attributes="selected not:form_vals">nicht suchen
          </option>
          <option tal:repeat="s python:db[prop.lnkname].list()"
                  tal:attributes="value    s/id;
                                  selected python:s.id in form_vals"
                  tal:content="python:s[prop.lnkattr]">
          </option>
         </select>
        </td>
       </tal:block>
       <td>
        <table border="0" class="form">
         <tr>
          <th />
          <td colspan="5" style="text-align:right">
           <a tal:attributes="href python:request.indexargs_url
            (classname, {'@action':'export_csv_names'})" i18n:translate="">
            Download as CSV
           </a>
          </td>
         </tr>
         <tr>
          <th>Volltextsuche:</th>
          <td colspan="5"><input name=":search_text"
                                 onChange="this.form.elements[':startwith'].value='0'"
                                 tal:attributes="value request/form/:search_text/value | nothing">
          (Sucht auch in Notizen)</td>
         </tr>
   <!-- submit button -->
         <tr>
          <th>Abfrage speichern als:</th>
          <td>
           <input type="text"
                  name="@queryname"
                  tal:attributes="value request/form/@queryname/value | default">
           <input type="submit"
                  value="Suche Starten / Speichern">
          </td>
         </tr>
        </table>
       </td>
      </tr>
     </table>
    </td>
   </tr>

   <tr>
    <td>
     <table border="0" bgcolor="#e0c0c0">
      <!-- fill in text entry fields -->
   <tal:block tal:repeat="prop nomulti_props">
      <tr>
       <th style="text-align:right;"
           tal:content="python:prop.label+':'"></th>
       <td>
        <input type="text"
               size="40"
               tal:define=
                "value python:request.form.getvalue(prop.name) or nothing"
               tal:attributes=
                " value python:prop.pretty_ids (value)
                ; name  python:prop.name
                ">
        <span tal:condition="python:prop.do_classhelp"
          tal:replace="structure python:db[prop.lnkname].classhelp
           ( properties=prop.classhelp_properties('description', 'firstname')
           , property=prop.selname
           , form='query'
           )"/>
       </td>
      </tr>
   </tal:block>
     </table>
    </td>
   </tr>


  </table>
</form>
</tal:block>

<!-- begin not used stuff from above -->
<!-- END -->


<!--
The following macros are intended to be used in search pages.

The invoking context must define a "name" variable which names the
property being searched.

See issue.search.html in the classic template for examples.
-->
<td metal:define-macro="search_input">
  <input tal:attributes="value python:request.form.getvalue(name) or nothing;
                         name name">
</td>

<td metal:define-macro="search_popup">
  <!--
    context needs to specify the popup "columns" as a comma-separated
    string (eg. "id,title" or "id,name,description") as well as name
  -->
  <input tal:attributes="value python:request.form.getvalue(name) or nothing;
                         name name">
  <span tal:replace="structure python:db.issue.classhelp(columns,
                                      property=name)" />
</td>

<td metal:define-macro="search_select">
  <select tal:attributes="name name"
          tal:define="value python:request.form.getvalue(name)">
    <option value="">nicht suchen</option>
    <tal:block metal:define-slot="extra_options"></tal:block>
    <option value="">------------</option>
    <option tal:repeat="s python:db[db_klass].list()"
            tal:attributes="value s/id; selected python:value == s.id"
            tal:content="python:s[db_content]"></option>
  </select>
</td>

<td metal:define-macro="search_checkboxes">
 <ul class="search-checkboxes"
     tal:define="value python:request.form.getvalue(name)">
 <li tal:repeat="s python:db[db_klass].list()">
  <input type="checkbox" tal:attributes="name name; id string:name-${s/id};
    value s/id; checked python:value == s.id" />
  <label tal:attributes="for string:$name-${s/id}" tal:content="s/name" />
 </li>
 <li metal:define-slot="no_value_item">
  <input type="checkbox" value="-1" tal:attributes="name name;
     id string:$name--1; checked python:value == '-1'" />
  <label tal:attributes="for string:$name--1">no value</label>
 </li>
 </ul>
</td>

<td metal:define-macro="column_input">
  <input type="checkbox" name="@columns"
         tal:attributes="value name;
                         checked python:name in cols">
</td>

<td metal:define-macro="sort_input">
  <input type="radio" name="@sort"
         tal:attributes="value name;
                         checked python:name == sort_on">
</td>

<td metal:define-macro="group_input">
  <input type="radio" name="@group"
         tal:attributes="value name;
                         checked python:name == group_on">
</td>
