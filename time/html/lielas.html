<tal:block metal:define-macro="icing">
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="de-DE" id="fb"
 tal:define="
   language        python: utils.set_language (request.client, db)
 ; uname           python: str (request.user.username)
 ; is_user         python: request.user.username!='anonymous'
 ; clsname         python: getattr (context, '_classname', '')
 ; classname       context/_classname|db/user/_classname
 ; locale          python: utils.getlocale (request.client, db)
   ">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <title metal:define-slot="head_title">LieLas</title>
  <link href="@@file/lielas_style.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript"
          src="@@file/lfiles/js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript"
          src="@@file/lfiles/js/jquery.tinysort.min.js"></script>
  <script type="text/javascript" src="@@file/lfiles/js/lielas.js"></script>
</head>
<body>
  <div id="frame">
    <div id="header">
      <div id="version">v1.0.0</div>
      <div id="navi">
        <div tal:condition="not:is_user" class="navi_item active">
          <div class="left"></div>
          <a>Login</a>
          <div class="right"></div>
        </div>
        <tal:block tal:condition="is_user">
          <div tal:repeat="cl python:utils.menu_by_class(db)"
               tal:attributes=
                  "class python:'navi_item'+['', ' active']
                    [(  cl [0] == clsname
                    or  (not cl [0] and clsname in
                        ('', 'sensor', 'device', 'measurement'))
                    )]">
            <tal:block
               tal:define=" n   python: cl [1]
                          ; url python: cl [2]
                          ">
              <div class="left"></div>
              <a tal:attributes="href url" tal:content="n"/>
              <div class="right"></div>
            </tal:block>
          </div>
          <div class="navi_item logout">
            <div class="left"></div>
            <a i18n:translate="" tal:attributes=
               "href python:request.indexargs_href ('', {'@action':'logout'})">
               Logout
            </a>
            <div class="right"></div>
          </div>
        </tal:block>
      </div>
    </div>
    <tal:block tal:condition="is_user">
      <tal:block metal:define-slot="content"/>
    </tal:block>
    <div id="content" tal:condition="not:is_user" class="login">
      <div id="sidebar">
        <div class="details_header">
            <strong>Login</strong>
        </div>
        <div class="details_body active_detail">
          <form method="POST" name="login_form" id="login_form"
                tal:attributes="action request/base">
            <ul class="details_row">
              <li>
                <label for="name" class="desc">Name:</label>
                <input type="text" name="__login_name" id="name" class="value"/>
              </li>
              <li>
                <label for="gruppe" class="desc">Passwort:</label>
                <input type="password" name="__login_password" id="pass"
                       class="value" />
              </li>
            </ul>
            <hr/>
            <div class="details_row">
              <input type="hidden" name="@action" id="login" value="Login"/>
              <span class="buttonbox submit_details orangebutton">
                <input type="submit" name="login" id="login_button"
                       value="Login" i18n:attributes="value"/>
              </span>
            </div>                           
          </form>
        </div>
        <div class="details_footer"></div>
      </div>
    </div>
  </div>
</body>
</html>
</tal:block>

<tal:block metal:define-macro="lielas-main">
  <tal:block metal:use-macro="templates/lielas/macros/icing">
    <tal:block metal:fill-slot="content">
      <tal:block tal:define=
          " devs  python: db.device.filter(None, {}, sort=('+', 'name'))
          ; asens python: utils.sensors_by_device (db, is_app = True)
          ; ssens python: utils.sensors_by_device (db, is_app = False)
          ; meas  python: utils.sensor_measurements (db)
          ; sel   python: (  classname in ('sensor' , 'device') and context
                          or devs [0]
                          ).designator()
          ">
        <div id="filter">
          <form method="GET" name="query" id="form_filter" action="measurement">
            <input type="hidden" id="rup_action" name=":action"
                   value="export_csv_lielas">
            <input type="hidden" name="sensor.is_app_sensor" value="yes">
            <input type="hidden" id="measurementdate" name="date"
                   tal:attributes="value python:
                       request.filterspec.get('date', '')">
            <div class="filter_item" id="filter_device">
              <h3 tal:content="structure python:utils.fieldlabel
                  ('sensor', 'device', csscls='')" />
              <select name="sensor.device" id="device_select"
                      multiple="multiple" class="filter_selector"
                      tal:define= "formval python: dict.fromkeys
                          (request.filterspec.get('sensor.device') or [])">
                <option value="" i18n:translate=""
                        tal:attributes="selected not:formval">- all -</option>
                <option tal:repeat="s python: db.device.filter
                        (None, {}, group = ('+', 'surrogate'))"
                        tal:content="python:s['surrogate']"
                        tal:attributes=
                            " value    s/id
                            ; selected python:s.id in formval
                            "/>
              </select>
            </div>
            <div class="filter_item" id="filter_sensor">
              <h3 tal:content="structure python:utils.fieldlabel
                  ('measurement', 'sensor', csscls='')" />
              <select name="sensor" id="sensor_select" multiple="multiple"
                      class="filter_selector" tal:define="formval python:
                        dict.fromkeys (request.filterspec.get('sensor') or [])">
                <option value="" i18n:translate=""
                        tal:attributes="selected not:formval">- all -</option>
                <option tal:repeat="s python: db.sensor.filter
                        ( None, {'is_app_sensor' : True}
                        , group = ('+', 'surrogate')
                        )"
                        tal:content="python:s['surrogate']"
                        tal:attributes=
                            " value    s/id
                            ; selected python:s.id in formval
                            "/>
              </select>
            </div>
            <div class="filter_item" id="filter_group">
              <h3 tal:content="structure python:utils.fieldlabel
                  ('device', 'device_group', csscls='')" />
              <select name="sensor.device.device_group" id="device_group_select"
                      multiple="multiple" class="filter_selector"
                      tal:define="formval python: dict.fromkeys
                          (request.filterspec.get('sensor.device.device_group')
                          or []
                          )">
                <option value="" i18n:translate=""
                        tal:attributes="selected not:formval">- all -</option>
                <option value="-1" tal:attributes="selected python:
                        '-1' in formval" i18n:translate="">- empty -</option>
                <option tal:repeat="s python: db.device_group.filter
                        (None, {}, group = ('+', 'name'))"
                        tal:content="python:s['name']"
                        tal:attributes=
                            " value    s/id
                            ; selected python:s.id in formval
                            "/>
              </select>
            </div>
            <div class="filter_item" id="filter_time">
              <h3 i18n:translate="">Time range:</h3>
              <div class="line_short">
                <label for="date_from" i18n:translate="">From:</label>
                <input name="date_from" id="date_from" class="filter_date"
                       type="text" />
                <img src="@@file/lfiles/images/datepicker.png"
                     width="28" height="20" id="datepick_from"
                      alt="Select date" i18n:attributes="alt"/> 
              </div>
              <div class="line_short">
                <label for="date_to" i18n:translate="">To:</label>
                <input name="date_to" id="date_to" class="filter_date"
                       type="text" />
                <img src="@@file/lfiles/images/datepicker.png"
                     width="28" height="20" id="datepick_to"
                      alt="Select date" i18n:attributes="alt"/> 
              </div>              
            </div>
            <div class="filter_item filter_submit" id="filter_submit"
                 tal:define=
                   " qn  request/form/@queryname/value|nothing
                   ; oqn request/form/@old-queryname/value|nothing
                   ">
              <div class="line_wide">
                <input name="@queryname" id="old_queryname" type="hidden"
                       tal:attributes="value python:qn or oqn or ''"/>
                <input name="@old-queryname" id="queryname" type="text"
                       value="Save filter..." title="Save filter..."
                       i18n:attributes="title"
                       tal:attributes="value python:oqn or qn or ''"/>
                <input name="save_filter" id=save_filter class="filterlink"
                   type="submit" value="Save filter"
                   i18n:attributes="value"/>
              </div>
              <div class="line_wide">
                <select name="filterladen" id="filterladen" >
                  <option value="" selected="selected"
                          tal:attributes="selected not:oqn"
                          i18n:translate="">select Filter...</option>
                  <option tal:repeat="q python:db.query.filter
                    (None, dict (klass = 'measurement'), sort=('+','name'))"
                    tal:content="q/name" tal:attributes=
                       " value q/designator
                       ; selected python:oqn==q.name
                       "/>
                </select>
                <input name="load_filter" id=load_filter class="filterlink" 
                   type="submit" value="Load" i18n:attributes="value"/>
              </div>
              <div class="line_wide">
                <span class="buttonbox greenbutton">
                  <input name="submit" type="submit" id="filtersend"
                         value="export CSV" i18n:attributes="value"/>
                </span>
                <span class="buttonbox graybutton">
                  <input name="reset" type="reset" id="filterreset"
                         value="reset" i18n:attributes="value"/>
                </span>
              </div>
            </div>
          </form>
        </div>
        <div id="content">
          <div id="list">
            <div class="list_header" i18n:translate="">Device list</div>
            <form id="form_list" action="">                                 
              <div id="list_body">
                <ul id="list_header">
                  <li>
                    <span class="col_collapse">
                      <img src="@@file/lfiles/images/clear.png"
                           width="15" height="14"
                           id="main_collapse" alt="collapse" />
                    </span>
                    <span class="col_check">
                      <input name="checked" type="checkbox" value=""
                             class="selectbox" />
                    </span>
                    <span class="col_id">
                      <a href="#" class="sort_link active"
                         i18n:translate="">Addr</a>
                    </span>
                    <span class="col_name">
                      <a href="#" class="sort_link">
                        <tal:block tal:replace="structure
                             python:utils.fieldlabel
                               ('device', 'name', endswith='')" />
                      </a>
                    </span>
                    <span class="col_device">
                      <a href="#" class="sort_link">
                      <a href="#" class="sort_link" i18n:translate="">
                        <tal:block tal:replace="structure
                             python:utils.fieldlabel
                               ('device', 'dev', endswith='')" />
                      </a>
                    </span>
                    <span class="col_group">
                      <a href="#" class="sort_link">
                        <tal:block tal:replace="structure
                             python:utils.fieldlabel
                               ('device', 'device_group', endswith='')" />
                      </a>
                    </span>
                    <span class="col_intervall">
                      <a href="#" class="sort_link">
                        <tal:block tal:replace="structure
                             python:utils.fieldlabel
                               ('device', 'mint', endswith='')" />
                      </a>
                    </span>
                  </li>
                </ul>
                <ul id="list_content">
                  <tal:block tal:repeat="d devs">
                    <li class="device" tal:attributes="id d/designator">
                      <div tal:attributes="class python:
                          'list_row main'
                           + ['', ' active_row'][d.designator() == sel]">
                        <span class="col_collapse">
                          <img src="@@file/lfiles/images/clear.png"
                               width="12" height="12" alt="collapse" />
                        </span>
                        <span class="col_check">
                          <input name="checker_main" type="checkbox"
                                 value="device_01" class="selectbox" />
                        </span>
                        <span class="col_id"     tal:content="d/adr" />
                        <span class="col_name"   tal:content="d/name" />
                        <span class="col_device" tal:content="d/dev" />
                        <span class="col_group"  tal:content="d/device_group" />
                        <span class="col_intervall"
                              tal:content="python: str (int (d.mint)) + ' s'" />
                      </div>
                      <ul tal:attributes="id python:d.designator() + '_sensor'"
                          class="sensor">
                        <li tal:repeat="s python:asens [d.id]"
                            tal:attributes="id s/designator">
                          <div tal:attributes="class python:
                              'list_row'
                               + ['', ' active_row'][s.designator() == sel]">
                            <span class="col_check">
                              <input name="checker_sub" type="checkbox"
                                     tal:attributes="value s/designator"
                                     class="selectbox" />
                            </span>
                            <span class="col_name"   tal:content="s/name" />
                            <span class="col_device" tal:content="s/adr" />
                          </div>
                        </li>
                      </ul>
                    </li>
                  </tal:block>
                </ul>
              </div>
              <div class="list_footer">
                <div id="csv_export">
                  <span i18n:translate="">
                    marked devices:
                  </span>
                  <span class="buttonbox greenbutton">
                    <input name="export" type="submit" id="export"
                           value="export CSV" i18n:attributes="value" />
                  </span>
                </div>
              </div>
            </form>
          </div>
          <div id="sidebar">
            <div class="details_header">
              <strong i18n:translate="">Details:</strong>
            </div>
            <tal:block tal:repeat="d devs">
              <div tal:attributes=
                     " id    python: 'details_' + d.designator()
                     ; class python:
                            'details_body'
                             + ['', ' active_detail'][d.designator() == sel]
                     ">
                <form method="POST" tal:attributes=
                      " id     python:'settings_form_' + d.designator()
                      ; name   python:'settings_form_' + d.designator()
                      ; action d/designator
                      ">
                  <ul class="details_row">
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'adr')" />
                      <span class="value" tal:content="d/adr" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'name')" />
                      <tal:block
                       tal:replace="structure python:d.name.field ()" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'dev')" />
                      <span class="value" tal:content="d/dev" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'device_group')" />
                      <tal:block tal:replace="structure d/device_group/menu" />
                    </li>
                  </ul>
                  <hr />
                  <ul class="details_row">
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'mint')" />
                      <tal:block
                       tal:replace="structure python:d.mint.field ()" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'sint')" />
                      <tal:block
                       tal:replace="structure python:d.sint.field ()" />
                    </li>
                  </ul>
                  <hr />
                  <div class="details_row">
                    <input type="hidden" name="@action" value="edit">
                    <span class="buttonbox submit_details orangebutton">
                      <input type="submit" name="submit_button"
                             value="Submit Changes" i18n:attributes="value" />
                    </span>
                  </div>
                </form>
                <div class="details_row header">
                  <tal:block tal:replace="structure python:utils.fieldlabel
                    ('sensor', 'name', endswith='')" />
                  <span class="value">
                    <tal:block tal:replace="structure python:utils.fieldlabel
                      ('sensor', 'adr', endswith='', csscls='unit')" />
                    <tal:block tal:replace="structure python:utils.fieldlabel
                      ('sensor', 'val', endswith='', csscls='default')" />
                  </span>
                </div>
                <ul class="details_row">
                  <li tal:repeat="s python:asens [d.id]">
                    <span class="desc" tal:content="s/name" />
                    <span class="value">
                      <span class="unit" tal:content="s/adr" />
                      <tal:block tal:condition="python:meas[s.id]">
                        <tal:block tal:replace="python:meas[s.id][0][1]" />
                        <tal:block tal:replace="s/unit" />
                      </tal:block>
                    </span>
                  </li>
                </ul>
                <div class="details_row header">
                  <span class="desc" i18n:translate="">Status</span>
                </div>
                <ul class="details_row">
                  <li tal:repeat="s python:ssens [d.id]">
                    <span class="desc" tal:content="s/name" />
                    <span class="value" tal:condition="python:meas[s.id]">
                      <tal:block tal:replace="python:meas[s.id][0][1]" />
                      <tal:block tal:replace="s/unit" />
                    </span>
                  </li>
                </ul>
              </div>
              <div tal:repeat="s python:asens[d.id]"
                   tal:attributes=
                     " id    python: 'details_' + s.designator()
                     ; class python:
                            'details_body'
                             + ['', ' active_detail'][s.designator() == sel]
                     ">
                <form method="POST" tal:attributes=
                      " id     python:'settings_form_' + s.designator()
                      ; name   python:'settings_form_' + s.designator()
                      ; action s/designator
                      ">
                  <ul class="details_row">
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'adr')" />
                      <span class="value" tal:content="s/device/adr" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('device', 'name')" />
                      <span class="value" tal:content="s/device/name" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('sensor', 'adr')" />
                      <span class="value" tal:content="s/adr" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('sensor', 'type')" />
                      <span class="value" tal:content="s/type" />
                    </li>
                  </ul>
                  <hr />
                  <ul class="details_row">
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('sensor', 'name')" />
                      <span class="value"
                       tal:content="structure python:s.name.field ()" />
                    </li>
                    <li>
                      <tal:block tal:replace="structure python:utils.fieldlabel
                           ('sensor', 'do_logging')" />
                      <span class="value">
                        <tal:block
                         tal:replace="structure python:s.do_logging.field ()" />
                      </span>
                    </li>
                  </ul>
                  <hr />
                  <div class="details_row">
                    <input type="hidden" name="@action" value="edit">
                    <span class="buttonbox submit_details orangebutton">
                      <input type="submit" name="submit_button"
                             value="Submit Changes" i18n:attributes="value" />
                    </span>
                  </div>
                </form>
                <div class="details_row header">
                  <span class="desc"
                   i18n:translate="">Latest measurements</span>
                </div>
                <ul class="details_row">
                  <li tal:repeat="m python:meas[s.id]">
                    <span class="desc" tal:content="python: m[0]"/>
                    <span class="value">
                      <tal:block tal:replace="python:
                           locale.format ('%2.2f', m[1])"/>
                      <tal:block tal:replace="s/unit"/>
                    </span>
                  </li>
                </ul>
              </div>
            </tal:block>
            <div class="details_footer"></div>
          </div>
        </div>
      </tal:block>
    </tal:block>
  </tal:block>
</tal:block>

<!-- needs "u" (current user or user-class") and "action" for the @action -->
<tal:block metal:define-macro="user_details">
            <ul class="details_row">
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'username')" />
                <span class="value" tal:content="structure u/username/field"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'password')" />
                <span class="value" tal:content="structure u/password/field"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'confirm')" />
                <span class="value" tal:content="structure u/password/confirm"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'realname')" />
                <span class="value" tal:content="structure u/realname/field"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'address')" />
                <span class="value" tal:content="structure u/address/field"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'status')" />
                <span class="value" tal:content="structure u/status/menu"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'roles')" />
                <span class="value" tal:content="structure u/roles/field"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'timezone')" />
                <span class="value" tal:content="structure u/timezone/field"/>
              </li>
              <li>
                <tal:block tal:replace="structure python:utils.fieldlabel
                     ('user', 'csv_delimiter')" />
                <span class="value"
                      tal:content="structure u/csv_delimiter/field"/>
              </li>
            </ul>
            <hr />
            <div class="details_row">
              <input type="hidden" name="@action"
                     tal:attributes="value rup_action">
              <span class="buttonbox submit_details orangebutton">
                <input type="submit" name="submit_button"
                       value="Submit Changes" i18n:attributes="value" />
              </span>
            </div>
</tal:block>
