<tal:block metal:use-macro="templates/page/macros/icing">

 <title metal:fill-slot="head_title">
  <span tal:condition="context/id"
        tal:replace="string:Defect: ${context/id} by ${context/creator}"></span>
  <span tal:condition="not:context/id"
        tal:replace="string:Create New Defect Report"></span>
 </title>

 <tal:block metal:fill-slot="create_or_query">
  <tal:block 
   metal:use-macro="templates/page/macros/create_or_query_new_tracker_item" />
 </tal:block>

 <tal:block metal:fill-slot="content">
  <tal:block metal:use-macro="templates/page/macros/ttt_issue">
   <tal:block metal:fill-slot="ttt_issue_content">
    <p tal:condition="context/closed/plain"
       tal:content="structure string:Closed on <b>${context/closed}</b>
                    by <b>${context/closer}</b>."></p>
    <input type="hidden" name="@required" value="product,version,severity,found_in_release">
    <tr>
     <th class="required">Product</th>
     <td tal:content="structure context/product/menu"></td>
    </tr>
    <tr>
     <th class="required">Version</th>
     <td tal:content="structure context/version/field"></td>
    </tr>
    <tr>
     <th class="required">Found in Release</th>
     <td>
      <span tal:condition="not:context/id"
            tal:content="structure context/found_in_release/menu"/>
      <span tal:condition="context/id"
            tal:define="item context/found_in_release">
       <a tal:attributes="href item/designator;
                          class string:release_${item/status}"
          tal:content="structure string:${item/title} <code>(${item/status/name}, ${item/responsible/nickname})</code>"></a>
       <input type="hidden" name="found_in_release"
              tal:attributes="value context/found_in_release/id">
       </span>
     </td>
    </tr>
    <tr>
     <th class="required">Severity</th>
     <td tal:content="structure context/severity/menu"></td>
     <th></th>
     <td></td>
    </tr>
    <tr>
     <th>Cert</th>
     <td tal:condition="not:context/id"
         tal:content="structure context/cert/field"></td>
     <td tal:condition="context/id"
         tal:content="context/cert"></td>
     <th></th>
     <td></td>
    </tr>
    <tr tal:condition="context/id">
     <th>Status</th>
     <td>
      <select name="status"
              tal:condition="python:context.cert.plain () == 'Yes' and request.user.hasPermission ('May Change Status', 'defect')"
              tal:define="ok context/status/cert_transitions">
       <option tal:attributes="value context/status/id"
               tal:content="context/status/name"></option>
       <tal:block tal:repeat="state db/defect_status/list">
       <option tal:condition="python:state.id in ok"
               tal:attributes="
                   value state/id;
                selected python:state.id == context.status.id"
               tal:content="state/name">
       </option>
       </tal:block>
      </select>
      <span tal:condition="python:context.cert.plain () == 'Yes' and not request.user.hasPermission ('May Change Status', 'defect')"
            tal:content="context/status"/>
      <select name="status"
              tal:condition="python:context.cert.plain () == 'No'"
              tal:define="ok context/status/transitions">
       <option tal:attributes="value context/status/id"
               tal:content="context/status/name"></option>
       <tal:block tal:repeat="state db/defect_status/list">
       <option tal:condition="python:state.id in ok"
               tal:attributes="
                   value state/id;
                selected python:state.id == context.status.id"
               tal:content="state/name">
       </option>
       </tal:block>
      </select>
      <span tal:condition="context/closer/isset">
       Closed by: <a tal:attributes="href context/closer/designator"
                     tal:content="context/closer"></a>
       on <span tal:replace="python: context.closed.pretty (format='%Y-%m-%d')"/>
      </span>
     </td>
     <th></th>
     <td></td>
    </tr>
    <tr tal:condition="context/id">
     <th>Solved in Release</th>
     <td class="task_list">
      <span tal:content="structure context/solved_in_release/menu"/>
      <tal:block tal:condition="context/solved_in_release/isset"
                 tal:define="item context/solved_in_release">
       <a tal:attributes="href item/designator;
                          class string:release_${item/status}"
          tal:content="structure string:${item/designator} (${item/status}, ${item/responsible/nickname})"></a>
      </tal:block>
     </td>
    </tr>
    <tr>
     <th>Belongs to Feature</th>
     <td class="task_list">
      <select name="belongs_to_feature"
              tal:define="curr context/belongs_to_feature/id | nothing">
       <option value="-1">- no selection -</option>
       <option tal:repeat="t python:db.feature.filter
                                 ( filterspec = { }
                                 , group      = ( '+', 'release')
                                 , sort       = ( '+', 'id'   )
                                 )"
               tal:attributes="value   t/id;
                               curr    curr;
                               selected python:t.id == curr"
               tal:content="string:${t/release} ${t/title}"></option>
      </select>
      <tal:block tal:condition="context/belongs_to_feature/isset"
                 tal:define="item context/belongs_to_feature">
       <a tal:attributes="href item/designator;
                          class string:feature_${item/status}_"
          tal:content="structure string:${item/designator} (${item/status/abbreviation}, ${item/responsible/nickname})"></a>
      </tal:block>
     </td>
    </tr>

    <tr tal:condition="context/belongs_to_feature/isset">
     <th>Belongs to Task</th>
     <td class="task_list">
      <select name="belongs_to_task"
              tal:define="curr context/belongs_to_task/id | nothing">
       <option value="-1">- no selection -</option>
       <option tal:repeat="t python:db.task.filter
                                 ( filterspec = { 'feature' : context.belongs_to_feature.id }
                                 , group      = ( '+', 'kind' )
                                 , sort       = ( '+', 'id'   )
                                 )"
               tal:attributes="value   t/id;
                               curr    curr;
                               selected python:t.id == curr"
               tal:content="t/title"></option>
      </select>
      <tal:block tal:condition="context/belongs_to_task/isset"
                 tal:define="item context/belongs_to_task;
                             postfix item/test_ok|python:''">
       <a tal:attributes="href item/designator;
                          class string:task_${item/status}_${postfix}"
          tal:content="structure string:${item/designator} (${item/status/abbreviation}, ${item/responsible/nickname})"></a>
      </tal:block>
     </td>
    </tr>

    <tr>
     <th>Estimated Effort</th>
     <td tal:content="structure context/estimated_effort/field"></td>
    </tr>
    <tr>
     <th>Fixed until</th>
     <td tal:content="structure context/fixed_until/field"></td>
    </tr>

    <tr tal:condition="context/id">
     <th>Duplicate of</th>
     <td class="task_list">
      <span tal:content="structure context/superseder/field"/>
      <span tal:replace="structure python:db.defect.classhelp
        ( 'id,title,responsible'
        , property='superseder'
        , width='600'
        , pagesize=500
        )" />
      <tal:block tal:condition="context/superseder/isset"
                 tal:define="item context/superseder">
       <br>
       <a tal:attributes="href item/designator;
                          class string:defect_${item/status}_"
          tal:content="structure string:${item/designator} (${item/status/abbreviation}, ${item/responsible/nickname}): ${item/title}"></a>
      </tal:block>
     </td>
    </tr>
    <tr tal:condition="context/id">
     <th>Fixed in</th>
     <td tal:content="structure context/fixed_in/field"></td>
    </tr>
    <tr tal:condition="python:context.id and context.cert.plain() == 'Yes'">
     <th>Files affected</th>
     <td>
      <textarea tal:content="request/form/files_affected/value | default"
                name="files_affected"
                wrap="hard"
                rows="5"
                cols="80"></textarea>
     </td>
    </tr>
    <tr>
     <th>Files</th>
     <td>
      <tal:block metal:use-macro="templates/page/macros/ttt_issue_files"/>
     </td>
    </tr>

   </tal:block>
  </tal:block>
 </tal:block>

</tal:block>
<!-- SHA: c16910c420861ab11a4dbfbebd149771fb8134e4 -->
