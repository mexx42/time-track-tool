<tal:block metal:use-macro="templates/page/macros/icing">
<title metal:fill-slot="head_title" tal:content="Classname" />
<span metal:fill-slot="body_title" tal:omit-tag="python:1" i18n:translate="">
 Time-Tracking for
 <span tal:condition="python:db._db.user.get
  (request.filterspec ['user'][0], 'firstname')">
  <span tal:replace="python: db._db.user.get
   (request.filterspec ['user'][0], 'firstname')" i18n:name="firstname"/>
  <span tal:replace="python: db._db.user.get
   (request.filterspec ['user'][0], 'lastname')"  i18n:name="lastname"/>
 </span>
 <span tal:condition="python:not db._db.user.get
   (request.filterspec ['user'][0], 'firstname')"
  tal:replace="python: db._db.user.get
   (request.filterspec ['user'][0], 'username')" i18n:name="username">
 </span>
</span>

<tal:block metal:fill-slot="create_or_query">
 <tal:block 
  metal:use-macro="templates/page/macros/create_or_query_new_tracker_item" />
</tal:block>

<tal:block metal:fill-slot="content">
 <tal:block tal:define=
  " batch request/batch
  ; pdict python: utils.properties_dict (db, context)
  ; pdict python: dict
    ( user   = utils.ExtProperty (utils, pdict ['user'],   multiselect = 1)
    , date   = utils.ExtProperty (utils, pdict ['date'])
    , status = utils.ExtProperty (utils, pdict ['status'], multiselect = 1)
    )
  ; props python: pdict.itervalues ()
  " tal:condition="context/is_view_ok">
  <tal:block tal:condition="not:context/is_view_ok">
   You are not allowed to view this page.
  </tal:block>

   <table class="list">
    <tr class="time-nav" tal:define="date python:pdict ['date']">
     <th>
      <a tal:attributes="href python:utils.prev_week (db, request)">
       &lt;&lt;&nbsp;previous
      </a>
     </th>
     <td>&nbsp;</td>
     <td>&nbsp;</td>
     <th style="text-align:right;"
         tal:content="structure
             python:utils.fieldname ('daily_record', 'week', space = 0) + ':'"/>
     <td>
      <form method="GET" name="q1" tal:attributes="action request/classname">
       <input type="hidden" name="@sort"     value="date">
       <input type="hidden" name="@group"    value="user">
       <input type="hidden" name="@filter"   value="date,user">
       <input type="hidden" name="@action"   value="weekno_action">
       <input type="hidden" name="@template" value="edit">
       <input type="text" size="7" name="weekno">
       <input type="hidden" name="user"
        tal:attributes="value python:request.form.getvalue ('user') or nothing">
       <input type="hidden" name="date"
        tal:attributes="value python:request.form.getvalue ('date') or nothing">
      </form>
     </td>
     <th style="text-align:right;"
      tal:content="structure
          python: utils.fieldname ('daily_record', 'date', space = 0) + ':'"/>
     <td>
      <form method="GET" name="q2" tal:attributes="action request/classname">
       <input type="hidden" name="@sort"     value="date">
       <input type="hidden" name="@group"    value="user">
       <input type="hidden" name="@filter"   value="date,user">
       <input type="hidden" name="@action"   value="daily_record_action">
       <input type="hidden" name="@template" value="edit">
       <input type="text" size="22"
        tal:define="value python:request.form.getvalue(date.selname) or nothing"
        tal:attributes="value python:date.pretty_ids (value)
                       ;name  python:date.selname
                       ">
       <input type="hidden" name="user"
        tal:attributes="value python:request.form.getvalue ('user') or nothing">
      </form>
     </td>
     <td>&nbsp;</td>
     <td>&nbsp;</td>
     <th>
      <a tal:attributes="href python:utils.next_week (db, request)">
       next&nbsp;&gt;&gt;
      </a>
     </th>
    </tr>
   </table>

  <form method="POST" tal:attributes="action request/classname">
   <tal:block tal:define="batch request/batch"
              tal:condition="context/is_view_ok">
    <table class="list">
     <tr>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'start',         space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'end',           space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'duration',      space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'wp',            space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'time_activity', space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'work_location', space = False)"/>
     </tr>
     <tal:block tal:repeat="i batch">
      <tal:block
       tal:define="class python:['normal','alt'][repeat['i'].index%2]
                  ;idx   python:repeat['i'].index + 1
                  ">
       <tr tal:attributes="class class">
        <td tal:content="structure python:i ['date'].pretty ('%a')"/>
        <td tal:content="structure python:i ['date'].pretty ('%Y-%m-%d')"
         colspan="2"/>
        <td tal:content="structure python:pdict ['status'].colonfield (i)"
         colspan="3"/>
       </tr>
       <tal:block tal:repeat="r python: i ['time_record']">
        <tr tal:attributes="class class">
         <td tal:repeat="pn python:['start','end','duration']">
          <tal:block tal:replace="structure python: r [pn].field (5)"/>
         </td>
         <td>
          <select
           tal:attributes="name python:'time_record%s@wp'%r.id">
           <option tal:attributes="selected not:r/wp/id" value="-1">
            - no selection -
           </option>
           <option tal:repeat="wp python:db.time_wp.filter
              (filterspec = {'bookers' : db._db.getuid ()})"
             tal:attributes=
               "value wp/id
               ;selected python:wp.id == r.wp.id
               "
             tal:content="python:' '.join
              ([str (wp [i]) for i in 'name','wp_no','project'])"/>
          </select>
         </td>
         <td tal:repeat="pn python:['time_activity','work_location']">
          <tal:block tal:replace="structure python: r [pn].menu ()"/>
         </td>
        </tr>
       </tal:block>
       <tr tal:condition="python: 1"
           tal:attributes="class class">
        <td tal:repeat="pn python:['start','end','duration']">
         <tal:block tal:replace="structure python:utils.new_property
          (context, db, 'time_record', -idx, pn).field (5)"/>
        </td>
        <td>
         <select
          tal:attributes="name python:'time_record-%d@wp'%idx">
          <option selected="selected" value="-1">- no selection -</option>
          <option tal:repeat="wp python:db.time_wp.filter
             (filterspec = {'bookers' : db._db.getuid ()})"
            tal:attributes="value wp/id"
            tal:content="python:' '.join
             ([str (wp [i]) for i in 'name','wp_no','project'])"/>
         </select>
        </td>
        <td tal:repeat="pn python:['time_activity','work_location']">
         <tal:block tal:replace="structure python:utils.new_property
           (context, db, 'time_record', -idx, pn).menu ()"/>
        </td>

        <input type="hidden"
         tal:attributes="name  python:'time_record-%d@daily_record'%idx
                        ;value python:i.id
                        "/>
       </tr>
      </tal:block>
     </tal:block>
     <tr><td colspan="5"/>
      <td>
       <input type="submit" value=" Save " i18n:attributes="value">
       <input type="hidden" name="@action" value="daily_record_edit_action">
       <input type="hidden" name="@template" value="edit">
       <tal:block tal:replace="structure python:request.indexargs_form
        (sort=1, group=1, filter=1, filterspec=1, columns=0)"/>
      </td>
     </tr>
    </table>
   </tal:block>
  </form>

 </tal:block>
</tal:block>
</tal:block>
