<tal:block metal:use-macro="templates/page/macros/icing">
<title metal:fill-slot="head_title" tal:content="Classname" />
<span metal:fill-slot="body_title" tal:omit-tag="python:1" i18n:translate="">
 Time-Tracking for
 <span tal:condition="python:db._db.user.get
  (request.filterspec ['user'][0], 'firstname')">
  <span tal:replace="python: db._db.user.get
   (request.filterspec ['user'][0], 'firstname')" i18n:name="firstname"/>
  <span tal:replace="python: db._db.user.get
   (request.filterspec ['user'][0], 'lastname')"  i18n:name="lastname"/>
 </span>
 <span tal:condition="python:not db._db.user.get
   (request.filterspec ['user'][0], 'firstname')"
  tal:replace="python: db._db.user.get
   (request.filterspec ['user'][0], 'username')" i18n:name="username">
 </span>
</span>

<tal:block metal:fill-slot="create_or_query">
 <tal:block 
  metal:use-macro="templates/page/macros/create_or_query_new_tracker_item" />
</tal:block>

<tal:block metal:fill-slot="content">
 <tal:block tal:define=
  " batch request/batch
  ; pdict python: utils.properties_dict (db, context)
  ; pdict python: dict
    ( user   = utils.ExtProperty (utils, pdict ['user'],   multiselect = 1)
    , date   = utils.ExtProperty (utils, pdict ['date'])
    , status = utils.ExtProperty (utils, pdict ['status'], multiselect = 1)
    )
  ; props python: pdict.itervalues ()
  " tal:condition="context/is_view_ok">
  <tal:block tal:condition="not:context/is_view_ok">
   You are not allowed to view this page.
  </tal:block>

  <form method="POST" tal:attributes="action request/classname"
   name="edit_daily_record">
   <table class="list">
    <tr class="time-nav" tal:define="date python:pdict ['date']">
     <th>
      <a tal:attributes="href python:utils.prev_week (db, request)">
       &lt;&lt;&nbsp;previous
      </a>
     </th>
     <th>
       <input type="hidden" name="@sort"     value="date">
       <input type="hidden" name="@group"    value="user">
       <input type="hidden" name="@filter"   value="date,user">
       <input type="hidden" name="@action"   value="daily_record_edit_action">
       <input type="hidden" name="@template" value="edit">
       <input type="hidden" name="@pagesize"
        tal:attributes="value python:request.form.getvalue ('@pagesize')
        or '50'">
       <input type="hidden" name="@startwith"
        tal:attributes="value python:request.form.getvalue ('@startwith')
        or '0'">
       <input type="hidden" name="user"
        tal:attributes="value python:request.form.getvalue ('user') or nothing">
       &nbsp;
     </th>
     <th>&nbsp;</th>
     <th style="text-align:right;"
         tal:content="structure
             python:utils.fieldname ('daily_record', 'week', space = 0) + ':'"/>
     <th>
       <input type="text" size="7" name="weekno"
        onChange="document.forms.edit_daily_record ['@action'].value =
            'weekno_action';
          document.edit_daily_record.submit ();">
     </th>
     <th style="text-align:right;"
      tal:content="structure
          python: utils.fieldname ('daily_record', 'date', space = 0) + ':'"/>
     <th>
      <input type="text" size="22"
       tal:define="value python:request.form.getvalue(date.selname) or nothing"
       tal:attributes="value python:date.pretty_ids (value)
                      ;name  python:date.selname
                      ">
     </th>
     <th>&nbsp;</th>
     <th>&nbsp;</th>
     <th>
      <a tal:attributes="href python:utils.next_week (db, request)">
       next&nbsp;&gt;&gt;
      </a>
     </th>
    </tr>
   </table>

   <tal:block tal:define=
    "batch        request/batch;
     is_open      python:utils.batch_has_status (batch, 'open');
     is_submitted python:utils.batch_has_status (batch, 'submitted');
    "
    tal:condition="context/is_view_ok">
    <table class="list">
     <tr>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'start',         space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'end',           space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'duration',      space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'wp',            space = False)"
          colspan="2"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'time_activity', space = False)"/>
      <th tal:content="structure python:utils.fieldname
          ('time_record', 'work_location', space = False)"/>
      <th tal:condition="is_open"
          tal:content="structure python:utils.fieldname
          ('time_record', 'split',         space = False)"/>
     </tr>
     <tal:block tal:repeat="i batch">
      <tal:block
       tal:condition="i/is_view_ok"
       tal:define="cls       python:['normal','alt'][repeat['i'].index%2]
                  ;idx       python:repeat['i'].index + 1
                  ;editable  python:str (i.status) == 'open'
                  ;w_allowed python:utils.weekend_allowed (db._db, i)
                  ;is_wend   python:i ['date'].pretty ('%a') in ('Sat','Sun')
                  ;allowed   python:w_allowed or not is_wend
                  ;wps       python:utils.sorted 
                             (utils.work_packages (db, i), ('project', 'name'))
                  ">
       <tr tal:attributes="class cls">
        <td class="subhead-nb"
         tal:content="structure python:i.date.pretty ('%a')"/>
        <td class="subhead" colspan="2"
         tal:content="structure python:i.date.pretty ('%Y-%m-%d')"/>
        <td class="subhead-nb" width="1%" nowrap
         tal:content="python:'(Week %s)' % utils.weekno (i.date)"/>
        <td class="subhead"
         tal:content="structure python:pdict ['status'].colonfield (i)"/>
        <td class="subhead"/>
        <td class="subhead"/>
        <td tal:condition="is_open"/>
       </tr>
       <tal:block tal:repeat="r python: utils.sorted
        (i ['time_record'], ('start','wp'))">
        <tr tal:attributes="class cls">
         <td tal:repeat="pn python:['start','end','duration']">
          <tal:block tal:replace="structure python: utils.ExtProperty
          (utils, r [pn], item = r, editable = editable, fieldwidth = 5)
          .as_listentry ()"/>
         </td>
         <td colspan="2">
          <select tal:condition="editable"
           tal:attributes="name python:'time_record%s@wp'%r.id">
           <option tal:attributes="selected not:r/wp/id" value="-1">
            - no selection -
           </option>
           <option tal:repeat="wp wps" tal:attributes=
               "value wp/id
               ;selected python:wp.id == r.wp.id
               "
             tal:content="python:' '.join
              ([str (wp [i]) for i in 'project','wp_no','name'])"/>
          </select>
          <span tal:condition="not:editable" tal:content="structure python:
           '&nbsp;'.join
            ([utils.ExtProperty
              (utils, i [0], item = i [1], lnkattr = i [2]).as_listentry ()
              for i in ((r.wp.project,r.wp,None),(r.wp,r,'wp_no'),(r.wp,r,None))
            ])
           "/>
         </td>
         <td tal:repeat="pn python:['time_activity','work_location']">
          <tal:block tal:replace="structure python: utils.ExtProperty
          (utils, r [pn], item = r, editable = editable).menu ()"/>
         </td>
         <td tal:condition="is_open">
          <tal:block tal:condition="editable"
           tal:replace="structure python: utils.ExtProperty
           (utils, r.split, item = r, editable = editable, fieldwidth = 5)
           .as_listentry ()"/>
         </td>
        </tr>
       </tal:block>
       <tr tal:condition="python: editable and allowed"
           tal:attributes="class cls">
        <td tal:repeat="pn python:['start','end','duration']">
         <tal:block tal:replace="structure python:utils.new_property
          (context, db, 'time_record', -idx, pn).field (5)"/>
        </td>
        <td colspan="2">
         <select
          tal:attributes="name python:'time_record-%d@wp'%idx">
          <option selected="selected" value="-1">- no selection -</option>
          <option tal:repeat="wp wps" tal:attributes="value wp/id"
           tal:content="python:' '.join
             ([str (wp [i]) for i in 'project','wp_no','name'])"/>
         </select>
        </td>
        <td tal:repeat="pn python:['time_activity','work_location']">
         <tal:block tal:replace="structure python:utils.new_property
           (context, db, 'time_record', -idx, pn).menu ()"/>
        </td>
        <td/>
        <input type="hidden"
         tal:attributes="name  python:'time_record-%d@daily_record'%idx
                        ;value python:i.id
                        "/>
       </tr>
      </tal:block>
     </tal:block>
     <tr tal:condition="is_open"><td colspan="5"/>
      <td>
       <tal:block tal:replace="structure python:utils.button_submit_to
        (db, request.filterspec ['user'][0], request.filterspec ['date'])"/>
      </td>
      <td>
       <input type="submit" value=" Save " i18n:attributes="value">
      </td>
      <td/>
     </tr>
     <tr tal:condition="python: not is_open and is_submitted"><td colspan="5"/>
      <td/>
      <td>
       <tal:block tal:replace="structure python:utils.button_approve
        (request.filterspec ['date'])"/>
      </td>
      <td/>
     </tr>
    </table>
   </tal:block>
  </form>

 </tal:block>
</tal:block>
</tal:block>
