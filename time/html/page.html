<tal:block metal:define-macro="icing">
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
                               "http://www.w3.org/TR/html4/strict.dtd">
<html tal:define="
   uname           python: str (request.user.username)
 ; classname       context/_classname|db/user/_classname
 ; Classname       python: i18n.gettext (classname)
 ; klass           python: db [classname] or default
 ; is_user         python: uname != 'anonymous'
 ; lbl             klass/_klass/labelprop
 ; labelprop       python: (lbl,'lastname')
                           [lbl == 'title' and hasattr (context, 'lastname')]
 ; props           python: klass._klass.getprops ()
 ; has_msgs        python: 'messages'    in props
 ; has_files       python: 'files'       in props
 ; has_resp        python: 'responsible' in props
 ; has_nosy        python: 'nosy'        in props
 ; use_labelprop   python: 1
 ; approval_for    python: utils.approval_for (db)
 ; uid             python: db._db.getuid ()
 ; default_query   string::action=search&:startwith=0&:pagesize=20&:sort=id&:sortdir=on&:columns=id,title,responsible
 ; default_queries python:
   { 'cost_center'  : ':columns=name,status,organisation&:sort=-name&'
                      ':filter=status&:pagesize=20&:startwith=0&status=5,1,2,4'
   , 'daily_record' : ':columns=id,user,date,status&:sort=-id&'
                      ':filter=user,date&:pagesize=20&:startwith=0&'
                      'date=.-1%%3B.%%2B1&user=%s' % uid
   , 'time_project' : ':columns=name,responsible,organisation,department'
                      ',status&:sort=name&:filter=status&:pagesize=20&'
                      ':startwith=0&status=1,2'
   , 'time_wp'      : ':columns=name,wp_no,responsible,project,time_start'
                      ',time_end,cost_center&:sort=name&:filter=bookers&'
                      ':pagesize=20&:startwith=0&bookers=%s' % uid
   , 'user'         : ':columns=lastname,firstname,nickname,username'
                      ',phone,room,position,supervisor&:sort=lastname&'
                      ':filter=status&:pagesize=20&:startwith=0&status=1'
   , 'user_dynamic' : ':columns=id,user,valid_from,org_location&:sort=-id&'
                      ':pagesize=20&:startwith=0'
   }
 ; menu_tracker  python:
   ( ( ('review',         'Edit')
     , ('meeting',        'Edit')
     , ('release',        'Edit')
     , ('feature',        'Edit')
     , ('defect',         'Edit')
     , ('user',           'Create')
     , ('public_holiday', 'Create')
     )
   , ( ('action_item',    'View')
     , ('announcement',   'View')
     , ('comment',        'View')
     , ('defect',         'View')
     , ('feature',        'View')
     , ('meeting',        'View')
     , ('release',        'View')
     , ('review',         'View')
     , ('task',           'View')
     , ('public_holiday', 'View')
     )
   )
 ; menu_time     python:
   ( ( ('cost_center',         'Edit')
     , ('cost_center_group',   'Edit')
     , ('cost_center_status',  'Edit')
     , ('daily_record',         None)
     , ('daily_record_status', 'Edit')
     , ('department',          'Edit')
     , ('user_dynamic',        'Edit')
     , ('location',            'Edit')
     , ('meeting_room',        'Edit')
     , ('org_location',        'Edit')
     , ('organisation',        'Edit')
     , ('position',            'Edit')
     , ('room',                'Edit')
     , ('time_activity',       'Edit')
     , ('time_project',        'Edit')
     , ('time_project_status', 'Edit')
     , ('time_record',          None)
     , ('time_wp_group',       'Edit')
     , ('time_wp',              None)
     , ('user',                'Create')
     , ('work_location',       'Edit')
     )
   , ( ('cost_center',   'View', '')
     , ('daily_record',  'View', 'controlling')
     , ('user_dynamic',  'View', '')
     , ('time_project',  'View', '')
     , ('time_wp',       'View', '')
     , ('time_wp_group', 'View', '')
     )
   )
 ; menu_type     python:
    dict ([(k [0],menu_time) for k in menu_time [0]])
">
 <head>
  <title metal:define-slot="head_title">
   <span tal:replace="Classname"/>
  </title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8;">
  <link rel="stylesheet" type="text/css" href="@@file/style.css">
  <script tal:replace="structure request/base_javascript"></script>
 </head>
 <body class="body">
  <table class="body" align="center" valign="middle"
   tal:condition="python:request.user.username=='anonymous'">
   <tr>
<!-- login -->
    <td>
<form method="POST" name="login_form" tal:attributes="action request/base">
     <table class="form">
      <tr>
       <td colspan="2" align="center">Welcome to <br>Roundup Issue Tracking system @ TTTech<br>
                                      <font size="-2">Note: You definitely need <b>Cookies</b> and <b>JavaScript</b> enabled.</font></td>
      </tr>
      <tr>
       <th>Login:</th>
       <td><input size="15" name="__login_name"></td>
      </tr>
      <tr>
       <th>Password:</th>
       <td><input size="15" type="password" name="__login_password"></td>
      </tr>
      <tr>
       <td colspan="2" align="center">
        <input type="submit" name="@action" value="Login">
<!-- XXX: needs some cleanup in this logic and also in the referring template
        <a href="user?@template=forgotten">Forgot your password?</a>
-->
       </td>
      </tr>
     </table>
     <script language="javascript">
     <!--
       document.login_form.__login_name.focus ();
       document.login_form.__login_name.select ();
     -->
     </script>
</form>
    </td>
   </tr>
  </table>

<!-- menubar -->
<form name="menubar">
  <table bgcolor="#eeeeee"
   tal:condition="python:request.user.username!='anonymous'">
   <tr>
<!-- home -->
<!--
    <td class="sidebar">
     <span class="classblock">
      <a tal:attributes="href config/TRACKER_WEB">Home</a>
     </span>
    </td>
-->

<!-- create new / query -->
    <tal:block metal:define-slot="create_or_query" />

<!-- template specific menues -->
<!--
    <tal:block metal:define-slot="menubar"></tal:block>
-->
    <!-- time-tracking for current daily_record selection or current week -->
    <td class="sidebar"
     tal:condition="python:db._db.user_dynamic.find (user = request.user.id)">
     <span class="classblock">
      <a tal:attributes="href python:
       [ 'daily_record?:action=daily_record_action&:template=edit'
       , str
         ( request.indexargs_url
          (classname, {'@action':'daily_record_action', '@template':'edit'})
         )
       ][classname == 'daily_record']">
       Time
      </a>
     </span>
    </td>

    <!-- approval if user can approve records -->
    <td class="sidebar"
     tal:condition="approval_for">
     <span class="classblock">
      <a tal:attributes="href python:
       [ 'daily_record?:template=approve&:sort=user&:filter=user&user=%s'
         % ','.join (approval_for.keys ())
       , str (request.indexargs_url (classname, {'@template':'approve'}))
       ][classname == 'daily_record']
      ">
       Approval
      </a>
     </span>
    </td>

<!-- user list -->
    <td class="sidebar">
     <span class="classblock">
      <a tal:condition="python:request.user.hasPermission('View', 'user')
                            or request.user.hasPermission('Edit', 'user')"
         tal:attributes="href python: 'user?' + default_queries ['user']">
         User&nbsp;List
      </a>
     </span>
    </td>

<!-- username -> link to own profile -->
    <td class="sidebar">
     <span class="classblock">
      <a tal:attributes="href string:user${request/user/id}"
         tal:content="string:${request/user/username}"></a>
     </span>
    </td>

<!-- logout -->
    <td class="sidebar">
     <span class="classblock">
      <a tal:attributes="href python:request.indexargs_href
         ('', {'@action':'logout'})">Logout</a>
     </span>
    </td>
   </tr>
  </table>
</form>

<!-- body_title -->
  <tal:block
   tal:condition="python:request.user.username!='anonymous'">
   <h3>
    <span metal:define-slot="body_title">
     <span tal:replace="Classname"/>
    </span>
   </h3>
  </tal:block>

<!-- errors --->
  <p tal:condition = "options/error_message | nothing"
     class         = "error-message"
     tal:repeat    = "m options/error_message"
     tal:content   = "structure m">error</p>
  <p tal:condition = "options/ok_message | nothing"
     class         = "ok-message"
     tal:repeat    = "m options/ok_message"
     tal:content   = "structure m">error</p>

<!-- page content -->
  <tal:block tal:condition="python:request.user.username!='anonymous'">
   <span class="content" metal:define-slot="content"></span>
  </tal:block>

<!-- debug output -->
 <pre tal:condition="request/form/debug | nothing" tal:content="request"></pre>
 </body>
</html>
</tal:block>


<!-- Macro to display selector for new item in menu -->
<td metal:define-macro="create_new" class="sidebar" nowrap>
 <span class="classblock">
  <select name="create_new"
          onChange="javascript:document.location=document.forms['menubar'].elements['create_new'].options[document.forms['menubar'].elements['create_new'].options.selectedIndex].value; ">
   <option value="">-- Create New --</option>
   <tal:block tal:repeat="k python:utils.sorted (klasses, (0,), i18n.gettext)">
    <option tal:condition="python:request.user.hasPermission(k [1], k [0])"
            tal:attributes="value python:k[0] + '?@template=item'"
            tal:content="python:i18n.gettext (k[0])" />
   </tal:block>
  </select>
 </span>
</td>

<!-- Macro to display query selector in menu -->
<td metal:define-macro="select_query" class="sidebar" nowrap>
 <span class="classblock"
       >
  <select name="query"
          onChange="javascript:document.location=document.forms['menubar'].elements['query'].options[document.forms['menubar'].elements['query'].options.selectedIndex].value; ">
   <option value="">-- View / Query --</option>
   <option value="query?@template=edit">Manage Queries</option>
   <tal:block
    tal:repeat="k python:utils.sorted (klasses, (0,), i18n.gettext)">
     <tal:block tal:define=
       " name  python:i18n.gettext (k [0])
       ; klass python:k [0]
       ; perm  python:k [1]
       ; role  python: ('',k [-1])[len (k) > 2]
       " tal:condition="python:
          (   request.user.hasPermission (perm, klass)
          and (not role or utils.user_has_role (db._db, uid, role))
          )">
         <option tal:attributes="value python:
          klass + '?' + default_queries.get (klass, default_query)"
          tal:content="name"/>
         <option tal:define="
            queries python:db.query.filter
             (filterspec={'private_for':None, 'klass':klass})"
          tal:repeat="q queries"
          tal:attributes="
            value string:${klass}?@template=index&@queryname=${q/name}&queryid=${q/id}&${q/url}"
          tal:content="structure string:&nbsp;&nbsp;${q/name}"
         >  Global Queries</option>
         <tal:block tal:condition="request/user/queries">
          <option tal:define="
             queries python:db.query.filter
              (filterspec=
               { 'private_for':request.user.id
               , 'klass':klass
               , 'id':[q.id for q in request.user.queries]
               }
              )"
           tal:repeat="q queries"
           tal:attributes="
             value string:${klass}?@template=index&@queryname=${q/name}&queryid=${q/id}&${q/url}"
           tal:content="structure string:&nbsp;&nbsp;&nbsp;&nbsp;${q/name}"
          >    Private Queries</option>
         </tal:block>

     </tal:block>
   </tal:block>
  </select>
 </span>
</td>

<!-- Macro to display selector for new class and query selector in menu
     This creates the menu items used in Tracker classes as default
-->
<tal:block metal:define-macro="create_or_query_new_tracker_item">
 <tal:block tal:define="menu python:menu_type.get (classname, menu_tracker)">
  <tal:block tal:define="klasses python: menu [0]">
   <td metal:use-macro="templates/page/macros/create_new" />
  </tal:block>

  <tal:block tal:define="klasses python: menu [1]">
   <td metal:use-macro="templates/page/macros/select_query" />
  </tal:block>
 </tal:block>
</tal:block>

<!-- the following macro is used for all pages which display a TTT_Issue_Class item. -->

<!-- ttt_issue is now a misnomer. Generalized this to fit most classes
     by checking availability of certain attributes.
     But I didn't want to change many *.item.html so the name sticks.
-->
<td metal:define-macro="ttt_issue">
 <span tal:condition="python:not (context.is_view_ok() or context.is_edit_ok())">
 You are not allowed to view this page.
 </span>
 <form method="POST"
       onSubmit="return submit_once()"
       name="itemSynopsis"
       enctype="multipart/form-data"
       tal:condition="context/is_view_ok"
       tal:attributes="action context/designator">

  <input type="hidden" name="@template" value="item">

  <table class="form" border="0">
   <tr tal:condition="use_labelprop">
    <th class="required"
     tal:content="structure python:utils.fieldname(classname, labelprop)"/>
    <td colspan="3"
        tal:content="structure python:context [labelprop].field (size=60)"/>
   </tr>
   <tr tal:condition="has_resp">
    <th tal:attributes="class responsible_required | default"
     tal:content="structure python:utils.fieldname(classname, 'responsible')">
    </th>
    <td colspan="3">
     <tal:block tal:define="name      string:responsible;
                            form      string:itemSynopsis;
                            dont_care string:don't care;
                            selected  context/responsible/id | string:0">
      <tal:block metal:use-macro="templates/userlist/macros/user"></tal:block>
     </tal:block>
    </td>
   </tr>

   <tal:block metal:define-slot="ttt_issue_content"></tal:block>

   <tr tal:condition="has_nosy">
    <th tal:content="structure python:utils.fieldname(classname, 'nosy')"></th>
    <td colspan="3">
     <span tal:replace="structure context/nosy/field"></span>
     <span tal:condition="context/is_edit_ok"
           tal:replace="structure python:db.user.classhelp
                                             ( 'username,firstname,lastname'
                                             , property='nosy'
                                             , width='600')"></span><br>
    </td>
   </tr>

   <tr metal:use-macro="templates/page/macros/message_box" />

   <tr tal:condition="context/is_edit_ok">
    <th></th>
    <td colspan="3">
     <tal:block tal:replace="structure context/submit"/>
     <input tal:condition="context/id"
            type="button" value="Show History"
            tal:attributes="onClick string:javascript:help_window('${context/designator}?@template=history','600','300')">
    </td>
   </tr>
  </table>
  <p tal:condition="context/id" tal:content="structure string:Created on
    <b>${context/creation}</b> by <b>${context/creator}</b>, last
    changed <b>${context/activity}</b> by <b>${context/actor}</b>."></p>

  <input type="hidden" name="@required"
         tal:attributes="value required_attributes | labelprop">
 </form>

 <table metal:use-macro="templates/page/macros/note_required" />
 <table metal:use-macro="templates/page/macros/message_display" />
</td>

<tal:block metal:define-macro="message_box">
  <tr tal:condition="python:context.is_edit_ok () and has_msgs">
   <th tal:content="structure python:utils.fieldname(classname,'msg')" />
   <td colspan="3">
    <textarea tal:content="request/form/@note/value | default"
              name="@note"
              wrap="hard"
              rows="8"
              cols="80"></textarea>
   </td>
  </tr>
</tal:block>

<tal:block metal:define-macro="note_required">
 <table class="form" tal:condition="not:context/id">
 <tr>
  <td>Note:&nbsp;</td>
  <th class="required">highlighted</th>
  <td>&nbsp;fields are required.</td>
 </tr>
 </table>
</tal:block>

<tal:block metal:define-macro="message_display">
 <table class="messages" tal:condition="python:has_msgs and context.messages">
  <tr>
   <th colspan="3" class="header">Messages</th>
  </tr>
  <tal:block tal:repeat="msg context/messages/reverse">
  <tr>
   <th><a tal:attributes="href string:msg${msg/id}"
          tal:content="string:msg${msg/id}"></a></th>
   <th tal:content="string:Author: ${msg/author}">author</th>
   <th tal:content="string:Date: ${msg/date}">date</th>
<!--
   <th>
    <form style="padding:0" tal:condition="context/is_edit_ok"
          tal:attributes="action string:issue${context/id}">
     <input type="hidden" name="@remove@messages" tal:attributes="value msg/id">
     <input type="hidden" name="@action" value="edit">
     <input type="submit" value="remove">
    </form>
   </th>
-->
  </tr>
  <tr>
   <td colspan="3" class="content">
    <pre tal:content="structure msg/content/hyperlinked">content</pre>
   </td>
  </tr>
  </tal:block>
 </table>
</tal:block>

<!-- list links to a group of items -->
<!-- needs items and klassname set up -->
<!-- klassname should be the name of the klass, is used for the style class -->
<!-- each item should be a HTMLItem with the following properties: -->
<!-- status/name, status/abbreviation, title, responsible -->
<!-- status should map a ${klassname}_${item/status}_${postfix} a.href class in style.css -->
<!--   where postfix will be "${item/test_ok|nothing}" -->
<tal:block metal:define-macro="ttt_task_list">
 <tal:block tal:repeat="item items"
            tal:define="postfix item/test_ok|python:''">
  <a tal:attributes="href item/designator;
                     class string:${klassname}_${item/status}_${postfix}"
     tal:content="structure string:<code>${item/designator} (${item/status/abbreviation}, ${item/responsible/nickname}):</code> ${item/title}"></a><br>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="ttt_simple_list">
 <tal:block tal:repeat="item items">
  <a tal:attributes="href item/designator;
                     class string:${klassname}_${item/status}"
     tal:content="structure string:<code>${item/designator} (${item/status}, ${item/responsible/nickname}):</code> ${item/title}"></a><br>
 </tal:block>
</tal:block>

<!-- the following lists a nice list of files plus file upload form -->
<tal:block metal:define-macro="ttt_issue_files">
 <!-- list of files -->
 <table class="files" tal:condition="context/files">
  <tr>
   <th>File name</th>
   <th>Uploaded</th>
   <th>Type</th>
  </tr>
  <tr tal:repeat="file context/files">
   <td>
    <a tal:attributes="href file/download_url"
       tal:content="file/name">dld link</a>
   </td>
   <td>
    <span tal:content="file/creator">creator's name</span>,
    <span tal:content="file/creation">creation date</span>
   </td>
   <td tal:content="file/type" />
  </tr>
 </table>
 <!-- add new file -->
 <input type="file" name="@file" size="40">
</tal:block>

<tal:block metal:define-macro="ttt_issue_pdf_files">
 <!-- list of files -->
 <table class="files" tal:condition="context/files">
  <tr>
   <th>File name</th>
   <th>Uploaded</th>
   <th>Type</th>
  </tr>
  <tr tal:repeat="file context/files">
   <td>
    <a tal:attributes="href file/download_url"
       tal:content="file/name">dld link</a>
   </td>
   <td>
    <span tal:content="file/creator">creator's name</span>,
    <span tal:content="file/creation">creation date</span>
   </td>
   <td tal:content="file/type" />
  </tr>
 </table>
 <!-- add new file -->
 <input type="file" name="pdf_file-1@content" size="40">
 <input type="hidden" name="@link@files" value="pdf_file-1">
</tal:block>


<!-- the following is used to have those nifty index/search form on one page -->
<!-- the caller needs to define a list of tuples for the properties: -->
<!--  props = (("<name to display>", "<designator>"), ...) -->

<tal:block metal:define-macro="ttt_search_nav">
<!-- previous / next links -->
   <tr>
    <th tal:attributes="colspan python:len(request.columns)">
     <table width="100%">
      <tr class="navigation">
       <th class="left">
        <a tal:define="prev batch/previous"
           tal:condition="prev"
           tal:attributes="href python:str(request.indexargs_href(request.classname,
           {':startwith':prev.first, ':pagesize':prev.size}))">&lt;&lt;&nbsp;previous</a></th>
       <th tal:condition="batch/sequence_length"
           tal:content="structure python:'<nobr>showing %d - %d of %d in total</nobr>'
                               % ( batch.start
                                 , batch.start + batch.length - 1
                                 , batch.sequence_length
                                 )"
           >
       </th>
       <th tal:condition="not:batch/sequence_length"><nobr>Sorry, no results found</nobr></th>
       <th class="right">
        <a tal:define="next batch/next"
           tal:condition="next"
           tal:attributes="href python:str(request.indexargs_href(request.classname,
           {':startwith':next.first, ':pagesize':next.size}))">next&nbsp;&gt;&gt;</a></th>
      </tr>
     </table>
    </th>
   </tr>
</tal:block>

<!--
 the next two ttt_search_display and ttt_search_form needs the following variables set up
 as follows:
 props: a tuple (or list) of ExtProperty objects. See extensions/extproperty.py
-->

<!-- display the search results -->
<tal:block metal:define-macro="ttt_search_results">
 <tal:block tal:condition="not:context/is_view_ok">
  You are not allowed to view this page.
 </tal:block>

 <tal:block tal:define="batch request/batch"
            tal:condition="context/is_view_ok">
  <table class="list" border=1>
   <tr>
<!-- list all properties we want to see -->
    <tal:block tal:repeat="prop props">
     <th tal:condition="python:request.show[prop.selname]"
         tal:content="python:prop.label"></th>
    </tal:block>
   </tr>
   <tal:block metal:use-macro="templates/page/macros/ttt_search_nav"></tal:block>
   <!-- items found -->
   <tal:block tal:repeat="i batch">
    <tr tal:condition="python:request.group[1] and
                              batch.propchanged(request.group[1])">
     <th tal:attributes="colspan python:len(request.columns)"
         tal:content="python:i[request.group[1]]" class="group">
     </th>
    </tr>
    <tr tal:attributes="class python:['normal', 'alt'][repeat['i'].index%2]">
     <!-- all the properties: label property and id will be made a link -->
     <!-- filter out only the properties the user wants to see -->
     <tal:block tal:repeat="prop props">
      <td tal:condition="python:request.show [prop.selname]"
          tal:content="structure python:prop.as_listentry (i)">
      </td>
     </tal:block>
    </tr>
   </tal:block> <!-- repeat i batch -->
  </table>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="ttt_search_form">
<!-- query specification form -->
<form method="GET"
      name="query"
      tal:define="
       filtered_props python: [p for p in props
                               if not p.lnkattr or not '.' in p.lnkname];
       multi_props    python: [p for p in filtered_props if p.multiselect];
       sort_props     python: [p for p in props if p.sortable ()];
       nomulti_props  python: [p for p in filtered_props
                               if not p.multiselect and p.searchable]
      "
      tal:attributes="action request/classname">
<!-- no need for "structure python:request.indexargs_form(..." all other
     values are set via the search form below, only "startwidth" should be
     set magically ...
    <tal:block tal:replace="structure python:request.indexargs_form(sort=0, group=0, filter=1, filterspec=1, columns=0, pagesize=0, ignore={'filter':'status', 'filterspec':'status'})">
    </tal:block>
 -->
  <input type="hidden" name=":action" value="search">
  <input type="hidden" name=":startwith" tal:attributes="value request/startwith">
  <table border="0" bgcolor="#e0c0c0">
   <tr>
    <th bgcolor="#C08080" i18n:translate="">
     Query
     <span tal:replace="Classname" i18n:name="Classname"/>
    </th>
   </tr>

   <tr>
    <td>
     View
     <input type="text" size="4" name=":pagesize"
            tal:attributes="value request/pagesize">
      items per page&nbsp;&nbsp;
      <a tal:attributes="href python:request.indexargs_url
            (classname, {'@action':'export_csv_names'})" i18n:translate="">
            Download as CSV
      </a>
      <br>
      Sort by:<select name=":sort"
                      onChange="this.form.elements[':startwith'].value='0'">
         <option value="">- nothing -</option>
         <option tal:repeat="prop sort_props"
                 tal:attributes="selected python:prop.name==request.sort[1];
                                 value    python:prop.name"
                 tal:content="python:prop.label"
         ></option>
        </select>
        Descending:<input type="checkbox"
                          name=":sortdir"
                          onChange="this.form.elements[':startwith'].value='0'"
                          tal:attributes="checked python:request.sort[0] == '-'">
     - Group by:<select name=":group"
                        onChange="this.form.elements[':startwith'].value='0'">
         <option value="">- nothing -</option>
         <option tal:repeat="prop sort_props"
                 tal:attributes="selected python:prop.name==request.group[1];
                                 value    python:prop.name"
                 tal:content="python:prop.label"
         ></option>
        </select>
        Descending:<input type="checkbox"
                          name=":groupdir"
                          onChange="this.form.elements[':startwith'].value='0'"
                          tal:attributes="checked python:request.group[0] == '-'">
    </td>
   </tr>

   <tr>
    <td>
     <table border="0" bgcolor="#e0c0c0">
      <!-- fill in custom query data -->
      <!-- fill in multi selection boxes -->
      <tr>
       <th style="text-align:left;">View:</th>
   <tal:block tal:repeat="prop multi_props">
       <th style="text-align:left;" tal:content="python:prop.label+':'"></th>
   </tal:block>
      </tr>

      <tr>
       <!-- View -->
       <td style="text-align:center;">
        <select multiple name=":columns" size="7">
         <option tal:repeat="prop filtered_props"
                 tal:attributes="selected python:request.show[prop.selname];
                                 value    python:prop.selname"
                 tal:content="python:prop.label"></option>
        </select>
       </td>
   <tal:block tal:repeat="prop multi_props">
       <td style="text-align:center;">
        <tal:block tal:condition="python:prop.selname in ['responsible', 'closer']"
                   tal:define="size      string:7;
                               name      python:prop.selname;
                               form      string:query;
                               dont_care string:don't care;
                               selected  python:str(request.filterspec.get(prop.selname) or [''])[1:-1]">
         <tal:block metal:use-macro="templates/userlist/macros/user_multi"></tal:block>
        </tal:block>
        <tal:block tal:condition="python:prop.selname == 'nosy'"
                   tal:define="size      string:7;
                               name      python:prop.selname;
                               form      string:query;
                               dont_care string:don't care;
                               selected  python:str(request.filterspec.get(prop.selname) or [''])[1:-1]">
         <tal:block metal:use-macro="templates/userlist/macros/nosy_multi"></tal:block>
        </tal:block>
        <tal:block tal:condition="python:prop.selname not in ['responsible', 'nosy', 'closer']">
         <select multiple
                 size="7"
                 tal:attributes="name python:prop.name"
                 tal:define="form_vals
                   python:request.filterspec.get(prop.name) or []">
          <option value=""
                  tal:attributes="selected not:form_vals">don't care
          </option>
          <option tal:repeat="s python:db[prop.lnkname].list()"
                  tal:attributes="value    s/id;
                                  selected python:s.id in form_vals"
                  tal:content="python:s[prop.lnkattr]">
          </option>
         </select>
        </tal:block>
       </td>
   </tal:block>
      </tr>
     </table>
    </td>
   </tr>

   <tr>
    <td>
     <table border="0" bgcolor="#e0c0c0">
      <!-- fill in text entry fields -->
   <tal:block tal:repeat="prop nomulti_props">
      <tr>
       <th style="text-align:right;"
           tal:content="python:prop.label+':'"></th>
       <td>
        <input type="text"
               size="40"
               tal:define="value python:request.form.getvalue(prop.selname) or nothing"
               tal:attributes="value python:prop.pretty_ids (value)
                              ;name  python:prop.selname
                              ">
        <span tal:condition="python:prop.lnkname"
          tal:replace="structure python:db[prop.lnkname].classhelp
           ( properties=prop.classhelp_properties ('description', 'status', 'responsible')
           , property=prop.selname
           , form='query'
           )"/>
       </td>
      </tr>
   </tal:block>
      <tr>
       <th style="text-align:right;">Search full text:</th>
       <td><input type="text"
                  size="40"
                  name=":search_text"
                  onChange="this.form.elements[':startwith'].value='0'"
                  tal:attributes="value request/form/:search_text/value | nothing">
       (Searches also in messages)</td>
      </tr>
<!-- submit button -->
      <tr>
       <th></th>
       <td>
        <input type="submit"
               value="Update view"
               onClick="document.forms ['query'].elements ['@queryname'].value = '';
                        document.forms ['query'].elements ['new_query'].value = '';
                        document.forms ['query'].elements ['queryid'].value = '';">
       </td>
      </tr>
      <tr tal:define="queryid   request/form/queryid/value | nothing;
                      new_query request/form/new_query/value | nothing;
                      u_q       python:[q.id for q in request.user.queries];
                      bla       python:u_q.sort(lambda l, r:cmp(int(l), int(r)))">
      <th style="text-align:right;">This query's name:</th>
       <td tal:define="queryid python:new_query and u_q.pop() or queryid">
        <input type="hidden" name="queryid" tal:attributes="value queryid | nothing">
        <span tal:condition="queryid">
         <span tal:condition="python:queryid in request.user.queries">
          <input type="hidden" name="@queryname">
          <input type="text"
                name="_queryname"
                tal:attributes="value request/form/@queryname/value | default">
          <input type="submit"
                 value="Update view & store this query"
                 onClick="document.forms ['query'].elements ['@queryname'].value =
                          document.forms ['query'].elements ['_queryname'].value;">(If you change the name, you create a new query!!!)
         </span>
         <span tal:condition="python:queryid not in request.user.queries">
          <input type="text"
                 name="@queryname"
                 onChange="document.forms ['query'].elements ['new_query'].value = '1'; ">
          <input type="hidden" name="new_query" value="">
          <input type="submit"
                 value="Update view & store this query as new">
         </span>
        </span>
        <span tal:condition="not:queryid">
         <input type="text"
                name="@queryname"
                onChange="document.forms ['query'].elements ['new_query'].value = '1'; ">
         <input type="hidden" name="new_query" value="">
         <input type="submit"
                value="Update view & store this query as new">
        </span>
       </td>
      </tr>
     </table>
    </td>
   </tr>
  </table>
</form>
</tal:block>
