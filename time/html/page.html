<tal:block metal:define-macro="icing">
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
                               "http://www.w3.org/TR/html4/strict.dtd">
<html tal:define="
   uname           python: str (request.user.username)
 ; classname       context/_classname|db/user/_classname
 ; Classname       python: i18n.gettext (classname)
 ; formname        python: 'itemSynopsis'
 ; head_title      Classname
 ; klass           python: db [classname] or default
 ; bclass          python: db._db.getclass (classname) or default
 ; is_user         python: request.user.username!='anonymous'
 ; labelprop       klass/_klass/labelprop
 ; props           python: klass._klass.getprops ()
 ; has_msgs        python: 'messages'    in props
 ; has_invoices    python: 'invoices'    in props
 ; has_letters     python: 'letters'     in props
 ; has_files       python: 'files'       in props
 ; want_files      python: True
 ; has_resp        python: 'responsible' in props
 ; has_nosy        python: 'nosy'        in props
 ; use_labelprop   python: 1
 ; approval_for    python: (   'time_record' in db._db.classes
                           and utils.approval_for (db)
                           )
 ; uid             python: db._db.getuid ()
 ; default_query   string::action=searchwithtemplate&@startwith=0&@pagesize=20&@sort=id&@sortdir=on&@columns=id,title,responsible
 ; n_sort          python: 2
 ; tplate_args     python: {}
 ; msg_box_height  python: 8
 ; may_remove_msgs python: False
 ; typecat         python:
   (   'adr_type_cat' in db._db.classes
   and ','.join (db._db.adr_type_cat.getnodeids ())
   )
 ; abo_adrtype     python: utils.valid_adr_types (db, adr_type_cat = 'ABO')
 ; terse           python: utils.get_from_form (request, 'terse')
 ; quiet           python: utils.get_from_form (request, 'quiet')
 ; default_queries python:
   { ('abo', '')        : '@columns=id,aboprice,amount,begin,'
                          'end,subscriber.lastname,payer.lastname&'
                          '@sort=-id&@pagesize=20&@startwith=0&'
                          '@quiet=1&@terse=1'
   , ('abo_type', '')   : '@columns=name,description,period,order,adr_type,'
                          'invoice_template&@sort=order&@pagesize=20&'
                          '@startwith=0'
   , ('abo_price', '')  : '@startwith=0&@pagesize=20&@sort=name&'
                          '@columns=name,amount,invoice_group,invoice_template'
   , ('address', '')    : '@quiet=1&@startwith=0&@pagesize=20&'
                          '@sort=lookalike_lastname,lookalike_firstname&'
                          '@columns=salutation,title,id,lastname,firstname,'
                          'country,street,postalcode,city&'
                          '@filter=valid&valid=1&@search_text=&'
                          '@queryname=&@terse=1'
   , ('adr_type', '')   : '@columns=id,code,description,typecat&'
                          '@sort=code&@filter=typecat&@pagesize=50&'
                          '@startwith=0&typecat=%s' % typecat
   , ('alias', '')      : '@columns=name,alias_to_alias,alias_to_user&'
                          '@pagesize=500&@startwith=0'
   , ('cost_center', '')
                        : '@columns=organisation_id,cost_center_group_id'
                          ',id,name,status,organisation&'
                          '@sort=name&@group=cost_center_group&'
                          '@filter=status&@pagesize=20&@startwith=0&'
                          'status=5,1,2,4'
   , ('category', '')   : '@columns=name,description,responsible,nosy,'
                          'valid,cert_sw&@sort=name&@filter=valid&'
                          '@pagesize=200&@startwith=0&valid=1'
   , ('contact', '')    : '@columns=contact,contact_type,address.firstname,'
                          'address.lastname,address.function&'
                          '@sort=-address.lastname,address.firstname,'
                          'contact_type&@pagesize=20&@startwith=0&@quiet=1'
   , ('cust_supp', '')  : '@pagesize=50&@startwith=0&'
                          '@columns=id,name,description,tax_id,status,attendant'
   , ('daily_record', '')
                        : '@columns=id,user,date,status&@sort=-id&'
                          '@filter=user,date&@pagesize=20&@startwith=0&'
                          'date=.-1d%%3B.%%2B1d&user=%s' % uid
   , ('daily_record_freeze', '')
                       : '@columns=id,date,balance,validity_date,frozen&'
                         '@sort=-date&@group=user&@filter=user&'
                         '@pagesize=20&@startwith=0&'
                         'user=%s' % uid
   , ('discount_group', '')
                        : '@columns=id,name,currency&'
                          '@sort=-id&@pagesize=20&@startwith=0'
   , ('doc', '')        : '@columns=title,document_nr,artefact,department&'
                          '@sort=title&@filter=status&status=-1,1,2,3'
   , ('group', '')      : '@columns=name,gid,description,org_location&'
                          '@sort=-id&@pagesize=500&@startwith=0'
   , ('invoice', '')    : '@quiet=1&@terse=1&@columns=invoice_no,'
                          'period_start,period_end,amount,currency,'
                          'balance_open,n_sent,payer.lastname,'
                          'subscriber.lastname,abo&'
                          '@sort=-period_start&@filter=open&'
                          '@pagesize=50&@startwith=0&open=1'
   , ('issue', '')      : '@columns=id,category,title,area,kind,status,'
                          'composed_of.id,part_of.id&'
                          '@sort=category&@group=-effective_prio&'
                          '@filter=status,responsible&@pagesize=50&'
                          '@startwith=0&status=1,2,3,4,5,7&responsible=%s' % uid
   , ('it_issue', '')   : '@columns=id,title,responsible,stakeholder,it_prio&'
                          '@sort=-id&@group=status&@filter=stakeholder,status&'
                          '@pagesize=50&@startwith=0&'
                          'status=1,2,3&stakeholder=%s' % uid
   , ('letter', '')     : '@columns=id,subject,date,address.lastname,'
                          'address.firstname&'
                          '@sort=-date&@pagesize=20&@startwith=0&'
                          '@quiet=1&@terse=1'
   , ('machine', '')    : '@columns=inventory_no,description,owner&'
                          '@sort=inventory_no&@pagesize=20&@startwith=0'
   , ('machine_name', '')
                        : '@columns=id,name,network_address,machine_name,'
                          'dns_record_type,do_reverse_mapping&@sort=name&'
                          '@pagesize=20&@startwith=0'
   , ('network_address', '')
                        : '@columns=ip,org_location,use_dhcp,network_interface&'
                          '@sort=ip&@group=org_location&@pagesize=20&'
                          '@startwith=0'
   , ('network_interface', '')
                        : '@columns=id,mac,card_type,description,machine&'
                          '@sort=-id&@pagesize=2000&@startwith=0'
   , ('overtime_correction', '')
                       : '@columns=id,user,date,value,comment&'
                         '@sort=-date&@filter=user&@pagesize=20&@startwith=0&'
                         'user=%s' % uid
   , ('payment', '')    : ':columns=date_payed,amount,invoice,receipt_no,'
                          'invoice.payer.lastname,invoice.payer.firstname,'
                          'invoice.currency,invoice.amount,invoice.abo&'
                          ':sort=date_payed&:pagesize=20&:startwith=0&'
                          '@quiet=1&@terse=1'
   , ('product', '')    : '@columns=name,product_group,measuring_unit,'
                          'packaging_unit,minimum_inventory&'
                          ':filter=status&:pagesize=50&:startwith=0&status=1'
   , ('public_holiday', '')
                        : '@columns=id,name,description,date,locations,is_half&'
                          '@sort=date&@filter=date&@pagesize=20&@startwith=0&'
                          'date=.%3B'
   , ('summary_report', 'staff')
                        : '@startwith=0&@pagesize=50&'
                          '@filter=summary_type,date,user&summary_type=2,4&'
                          'user=%s&date=%s%%3B.' %
                          (uid, utils.monthstart_twoweeksago ())
   , ('summary_report', '')
                        : '@columns=user,time_wp,summary&'
                          '@filter=user,summary_type,status,date,show_empty,'
                          'show_all_users,show_missing&'
                          '@pagesize=50&@startwith=0&status=3,1,2&'
                          'date=%s%%3B.&summary_type=2,4&user=%s&'
                          'show_empty=no&show_all_users=no&show_missing=no' %
                          (utils.monthstart_twoweeksago (), uid)
   , ('time_project', '')
                        : '@columns=name,responsible,organisation,department'
                          ',status&@sort=name&@filter=status&@pagesize=20&'
                          '@startwith=0&status=1,2'
   , ('time_record', '')
                        : '@columns=daily_record.user,daily_record.date,'
                          'daily_record.status,wp.project,wp,time_activity,'
                          'work_location,duration,tr_duration,comment&'
                          '@sort=daily_record.user,daily_record.date,'
                          'wp.project,wp&@filter=daily_record.user,'
                          'daily_record.date&@pagesize=50&@startwith=0&'
                          'daily_record.user=%s&daily_record.date=.-30d%%3B.'
                           % (uid,)
   , ('time_wp', '')    : '@columns=name,wp_no,responsible,project,time_start'
                          ',time_end,cost_center&@sort=name&@filter=bookers&'
                          '@pagesize=20&@startwith=0&bookers=%s' % uid
   , ('time_wp_group', '')
                        : '@columns=id,name,description,wps&@sort=name&'
                          '@pagesize=20&@startwith=0'
   , ('tmplate', '')    : '@columns=id,name,tmplate_status&@sort=name&'
                          '@pagesize=20&@startwith=0'
   , ('user', '')       : '@columns=%s%s&@sort=%s&'
                          '@filter=status&@pagesize=500&@startwith=0&status=1'
                          % ( ','.join
                              (n for n in
                               ( 'lastname'
                               , 'firstname'
                               , 'nickname'
                               , 'username'
                               , 'phone'
                               , 'room'
                               , 'position'
                               , 'supervisor'
                               )
                              if n in db._db.user.properties
                              )
                            , ['', ',realname']
                              ['lastname' not in db._db.user.properties]
                            , ['username', 'lastname']
                              ['lastname' in db._db.user.properties]
                            )
   , ('user_dynamic', '')
                       : '@columns=id,user,valid_from,org_location&@sort=-id&'
                         '@pagesize=20&@startwith=0'
   }
 ; menu_tracker  python:
   ( ( ('review',         'Edit',   '?@template=item', 1)
     , ('meeting',        'Edit',   '?@template=item', 1)
     , ('release',        'Edit',   '?@template=item', 1)
     , ('feature',        'Edit',   '?@template=item', 1)
     , ('defect',         'Edit',   '?@template=item', 1)
     )
   , ( ('action_item',    'View')
     , ('announcement',   'View')
     , ('comment',        'View')
     , ('defect',         'View')
     , ('feature',        'View')
     , ('meeting',        'View')
     , ('release',        'View')
     , ('review',         'View')
     , ('task',           'View')
     )
   )
 ; new_issue     python:
    '?@template=item&@note='
    'Current%20behavior%3A%0AWhat%20is%20the%20current%20status%3F%20What%20is%20wrong%3F%0A%0AExpected%20behavior%3A%0AHow%20should%20it%20be%3F%20If%20possible%2C%20add%20a%20reference%20to%20a%20specification%20or%20a%0Atest%20case.%0A%0AReproducibility%3A%0AIs%20the%20erroneous%20behavior%20reproducible%3F%20How%3F%0ADocument%20which%20branches%20are%20affected.%0A%0AIf%20the%20status%20is%20set%20to%20%22open%22%20or%20%22escalated%22%2C%20write%20down%20the%20analysis%0Aand%20decision.%20Dont%27t%20forget%20to%20fill%20in%20the%20Release/Version%20of%20the%0Aaffected%20product%20and%20to%20attach%20all%20files%20needed%20to%20reproduce%20the%0Aproblem.%0A'
 ; menu_time     python:
   ( ( ('cost_center',         'Edit',   '?@template=item', 1)
     , ('cost_center_group',   'Edit',   '?@template=item', 1)
     , ('cost_center_status',  'Edit',   '?@template=item', 1)
     , ('daily_record',         None,    '',                1)
     , ('daily_record_status', 'Edit',   '?@template=item', 1)
     , ('department',          'Edit',   '?@template=item', 1)
     , ('user_dynamic',        'Edit',   '?@template=item', 1)
     , ('location',            'Edit',   '?@template=item', 1)
     , ('meeting_room',        'Edit',   '?@template=item', 1)
     , ('org_location',        'View',   '?@template=item', 1)
     , ('organisation',        'Edit',   '?@template=item', 1)
     , ('position',            'Edit',   '?@template=item', 1)
     , ('room',                'Edit',   '?@template=item', 1)
     , ('time_activity',       'Edit',   '?@template=item', 1)
     , ('time_project',        'Edit', '?@template=item&op_project=True', 1)
     , ('time_project_status', 'Edit',   '?@template=item', 1)
     , ('time_record',          None,    '',                1)
     , ('time_wp_group',       'Edit',   '?@template=item', 1)
     , ('time_wp',              None,    '',                1)
     , ('user',                'Create', '?@template=item', 1)
     , ('work_location',       'Edit',   '?@template=item', 1)
     , ('public_holiday',      'Edit',   '?@template=item', 1)
     , ('summary_report',      None,     '',                1)
     , ('network_interface',   'Edit',   '?@template=item', 1)
     , ('machine',             'Edit',   '?@template=item', 1)
     , ('dns_record_type',     'Edit',   '?@template=item', 1)
     , ('operating_system',    'View',   '?@template=item', 1)
     , ('ip_subnet',           'View',   '?@template=item', 1)
     , ('network_address',     'Edit', '?@template=item&use_dhcp=True', 1)
     , ( 'machine_name'
       , 'Edit'
       , '?@template=item&do_reverse_mapping=True'
       , 1
       )
     , ('group',               'Edit',   '?@template=item', 1)
     , ('alias',               'Edit', '?@template=item&use_in_ln=True', 1)
     , ('smb_domain',          'View',   '?@template=item', 1)
     , ('smb_machine',         'Edit',   '?@template=item', 1)
     , ('it_issue',            'Edit',   '?@template=item', 1)
     , ( 'it_project'
       , 'Edit'
       , '?@template=item&confidential=1'
       , utils.user_has_role (db._db, db._db.getuid (), 'IT')
       )
     , ('it_issue_status',     'Edit',   '?@template=item', 1)
     , ('it_project_status',   'Edit',   '?@template=item', 1)
     , ('it_prio',             'Edit',   '?@template=item', 1)
     , ('it_category',         'Edit',   '?@template=item', 1)
     , ('area',                'Edit',   '?@template=item', 1)
     , ('category',            'Edit',   '?@template=item', 1)
     , ('status_transition',   'Edit',   '?@template=item', 1)
     , ('kind',                'Edit',   '?@template=item', 1)
     , ('keyword',             'Edit',   '?@template=item', 1)
     , ('status',              'Edit',   '?@template=item', 1)
     , ('msg_keyword',         'Edit',   '?@template=item', 1)
     , ('issue',               'Edit',   new_issue,         1)
     , ('query',               'Edit',   '?@template=item', 1)
     , ('severity',            'Edit',   '?@template=item', 1)
     , ('overtime_correction', 'Edit',   '?@template=item', 1)
     , ('daily_record_freeze', 'Edit',   '?@template=item&frozen=1', 1)
     , ('abo',                 'Edit',   '?@template=item', 1)
     , ('abo_type',            'Edit',   '?@template=item', 1)
     , ('address',             'Edit',   '?@template=item', 1)
     , ('valid',               'Edit',   '?@template=item', 1)
     , ('abo_price',           'Edit',   '?@template=item&valid=1', 1)
     , ('invoice_group',       'Edit',   '?@template=item', 1)
     , ('invoice_template',    'Edit',   '?@template=item', 1)
     , ('adr_type',            'Edit',   '?@template=item', 1)
     , ('adr_type_cat',        'Edit',   '?@template=item', 1)
     , ('currency',            'Edit',   '?@template=item', 1)
     , ('tmplate',             'Edit',   '?@template=item', 1)
     , ('tmplate_status',      'Edit',   '?@template=item', 1)
     , ('legalclient',         'Edit',   '?@template=item', 1)
     , ('contact_type',        'Edit',   '?@template=item', 1)
     , ('customer_group',      'Edit',   '?@template=item', 1)
     , ('customer_status',     'Edit',   '?@template=item', 1)
     , ('cust_supp',           'Edit',   '?@template=item', 1)
     , ('discount_group',      'Edit',   '?@template=item', 1)
     , ('dispatch_type',       'Edit',   '?@template=item', 1)
     , ('invoice_dispatch',    'Edit',   '?@template=item', 1)
     , ('measuring_unit',      'Edit',   '?@template=item', 1)
     , ('packaging_unit',      'Edit',   '?@template=item', 1)
     , ('pharma_ref',          'Edit',   '?@template=item', 1)
     , ('proceeds_group',      'Edit',   '?@template=item', 1)
     , ('product',             'Edit',   '?@template=item', 1)
     , ('product_group',       'Edit',   '?@template=item', 1)
     , ('product_status',      'Edit',   '?@template=item', 1)
     , ('sales_conditions',    'Edit',   '?@template=item', 1)
     , ('shelf_life_code',     'Edit',   '?@template=item', 1)
     , ('supplier_group',      'Edit',   '?@template=item', 1)
     , ('supplier_status',     'Edit',   '?@template=item', 1)
     , ('doc',                 'Edit',   '?@template=item', 1)
     , ('artefact',            'Edit',   '?@template=item', 1)
     , ('reference',           'Edit',   '?@template=item', 1)
     , ('overtime_period',     'Edit',   '?@template=item', 1)
     )
   , ( ('cost_center',         'View', 1,               ('',''))
     , ( 'daily_record'
       , 'View'
       , utils.user_has_role (db._db, db._db.getuid (), 'controlling', 'hr')
       , ('','')
       )
     , ('user_dynamic',        'View', 1,               ('',''))
     , ('time_project',        'View', 1,               ('',''))
     , ('time_wp',             'View', 1,               ('',''))
     , ('time_wp_group',       'View', 1,               ('',''))
     , ('public_holiday',      'View', 1,               ('',''))
     , ('user',                'View', 1,               ('',''))
     , ( 'user'
       , 'View'
       , db.user.roles.is_view_ok ()
       , ('roles','role')
       )
     , ('summary_report',      'View', 1,               ('',''))
     , ('network_interface',   'View', 1,               ('',''))
     , ('machine',             'View', 1,               ('',''))
     , ('network_address',     'View', 1,               ('',''))
     , ('machine_name',        'View', 1,               ('',''))
     , ('group',               'View', 1,               ('',''))
     , ('alias',               'View', 1,               ('',''))
     , ('smb_machine',         'View', 1,               ('',''))
     , ('it_issue',            'View', 1,               ('',''))
     , ('it_project',          'View', 1,               ('',''))
     , ('issue',               'View', 1,               ('',''))
     , ('time_record',         'View', 1,               ('',''))
     , ('category',            'View', 1,               ('',''))
     , ('overtime_correction', 'View', 1,               ('',''))
     , ('daily_record_freeze', 'View', 1,               ('',''))
     , ('abo',                 'View', 1,               ('',''))
     , ('abo_type',            'View', 1,               ('',''))
     , ('address',             'View', 1,               ('',''))
     , ('valid',               'View', 1,               ('',''))
     , ('abo_price',           'View', 1,               ('',''))
     , ('invoice',             'View', 1, ('generate invoices','send'))
     , ('invoice',             'View', 1,               ('',''))
     , ('payment',             'View', 1,               ('',''))
     , ('invoice_group',       'View', 1,               ('',''))
     , ('invoice_template',    'View', 1,               ('',''))
     , ('adr_type',            'View', 1,               ('',''))
     , ('adr_type_cat',        'View', 1,               ('',''))
     , ('currency',            'View', 1,               ('',''))
     , ('tmplate',             'View', 1,               ('',''))
     , ('tmplate_status',      'View', 1,               ('',''))
     , ('letter',              'View', 1,               ('',''))
     , ('legalclient',         'View', 1,               ('',''))
     , ('cust_supp',           'View', 1,               ('',''))
     , ('discount_group',      'View', 1,               ('',''))
     , ('product',             'View', 1,               ('',''))
     , ('contact',             'View', 1,               ('',''))
     , ('doc',                 'View', 1,               ('',''))
     , ('artefact',            'View', 1,               ('',''))
     , ('reference',           'View', 1,               ('',''))
     , ( 'summary_report'
       , 'View'
       , utils.user_has_role (db._db, db._db.getuid (), 'hr')
       , ('Staff Report','staff')
       )
     )
   )
 ; menu_type     python:
    dict ([(k [0],menu_tracker) for k in menu_tracker [0]])
">
 <head>
  <title metal:define-slot="head_title">
   <span tal:replace="head_title"/>
  </title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8;">
  <link rel="stylesheet" type="text/css" href="@@file/style.css">
  <script tal:replace="structure request/base_javascript"></script>
 </head>
 <body class="body">
  <table class="body" align="center" valign="middle"
   tal:condition="not:is_user">
   <tr>
<!-- login -->
    <td>
<form method="POST" name="login_form" tal:attributes="action request/base">
     <table class="form">
      <tr>
       <td colspan="2" align="center">
        <span i18n:translate="">Welcome:</span>
        <br>
        <tal:block tal:replace="config/TRACKER_NAME"/>
        <br>
        <font size="-2">
         <span i18n:translate="">
         Note: You definitely need <b>Cookies</b> and <b>JavaScript</b> enabled.
         </span>
        </font>
       </td>
      </tr>
      <tr>
       <th i18n:translate="">Login:</th>
       <td><input size="15" name="__login_name"></td>
      </tr>
      <tr>
       <th i18n:translate="">Password:</th>
       <td><input size="15" type="password" name="__login_password"></td>
      </tr>
      <tr>
       <th i18n:translate="">Remember me?:</th>
       <td><input type="checkbox" name="remember" id="remember"></td>
      </tr>
      <tr>
       <td colspan="2" align="center">
        <input type="submit" name="@action" value="Login">
       </td>
      </tr>
     </table>
     <script language="javascript">
     <!--
       document.login_form.__login_name.focus ();
       document.login_form.__login_name.select ();
     -->
     </script>
</form>
    </td>
   </tr>
  </table>

<!-- menubar -->
<form name="menubar">
  <table bgcolor="#eeeeee" tal:condition="is_user">
   <tr>

    <!-- create new / query -->
    <tal:block metal:define-slot="create_or_query" />

    <!-- template specific menues -->
    <!-- time-tracking for current daily_record selection or current week -->
    <td class="sidebar">
     <span tal:condition="python:
      (   'user_dynamic' in db._db.classes
      and db._db.user_dynamic.find (user = request.user.id)
      )">
      <span class="classblock">
       <a i18n:translate=""
          tal:attributes="href python:utils.time_url (request, classname)">
        Time
       </a>
      </span>
     </span>

     <!-- approval if user can approve records -->
     <span tal:condition="approval_for" class="classblock">
       <a i18n:translate="" tal:attributes="href python:
        [ 'daily_record?:template=approve&:sort=user&:filter=user&user=%s'
          % ','.join (approval_for.keys ())
        , str (request.indexargs_url (classname, {'@template':'approve'}))
        ][   classname == 'daily_record'
         and request.template not in ('approve','edit')
         ]">
        Approval
       </a>
     </span>

     <!-- custom classes with "New" Button -->
     <tal:block tal:repeat="c python:
                [('address', 'customer_group'), ('cust_supp', 'abo')]">
        <tal:block tal:condition="python:
          (   c [0] in db._db.classes
          and not c [1] in db._db.classes
          and request.user.hasPermission('View', c [0])
          )">
         <span class="classblock">
          <a tal:condition="python:request.user.hasPermission('View', c [0]) or
                                   request.user.hasPermission('Edit', c [0])"
             tal:attributes="href python:
                 '%s?%s' % (c [0], default_queries.get ((c [0], ''), ''))"
             tal:content="python:i18n.gettext (c [0])"/>
          <span tal:condition="python:
                request.user.hasPermission('Edit', c [0])">
             /
             <a tal:attributes="href python:'%s?:template=item' % c [0]">Neu</a>
          </span>
         </span>
        </tal:block>
     </tal:block>

     <!-- other custom classes with special template -->
     <tal:block tal:repeat="c python:[('invoice','send')]">
        <tal:block tal:condition="python:
          (   'invoice' in db._db.classes
          and  request.user.hasPermission('Edit', c [0])
          )">
         <span class="classblock">
          <a tal:condition="python:request.user.hasPermission('Edit', c [0])"
             tal:attributes=
              "href python:'%s?%s&@template=%s' %
                (c [0], default_queries.get ((c [0], ''), ''), c [1])"
             tal:content="python:i18n.gettext (c [0])">xyzzy</a>
         </span>
        </tal:block>
     </tal:block>

     <!-- user list -->
     <span class="classblock">
      <a tal:condition="python:request.user.hasPermission('View', 'user')
                            or request.user.hasPermission('Edit', 'user')"
         tal:attributes="href python: 'user?' + default_queries [('user','')]"
         i18n:translate="">
         User&nbsp;List
      </a>
     </span>

     <!-- username -> link to own profile -->
     <span class="classblock">
      <a tal:attributes="href string:user${request/user/id}"
         tal:content="string:${request/user/username}"></a>
     </span>

     <!-- logout -->
     <span class="classblock">
      <a tal:attributes="href python:request.indexargs_href
         ('', {'@action':'logout'})">Logout</a>
     </span>
   </tr>
   <tal:block metal:define-slot="menu_slot"/>
  </table>
</form>

<!-- body_title -->
  <tal:block tal:condition="is_user">
   <h3>
    <span metal:define-slot="body_title">
     <span tal:replace="head_title"/>
    </span>
   </h3>
  </tal:block>

<!-- errors --->
  <p tal:condition = "options/error_message | nothing"
     class         = "error-message"
     tal:repeat    = "m options/error_message"
     tal:content   = "structure m">error</p>
  <p tal:condition = "options/ok_message | nothing"
     class         = "ok-message"
     tal:repeat    = "m options/ok_message"
     tal:content   = "structure m">error</p>

<!-- page content -->
  <tal:block tal:condition="is_user">
   <span class="content" metal:define-slot="content"></span>
  </tal:block>

<!-- debug output -->
 <pre tal:condition="request/form/debug | nothing" tal:content="request"></pre>
 </body>
</html>
</tal:block>


<!-- Macro to display selector for new item in menu -->
<td metal:define-macro="create_new" class="sidebar" nowrap>
 <span class="classblock">
  <select name="create_new"
          onChange="javascript:document.location=document.forms['menubar'].elements['create_new'].options[document.forms['menubar'].elements['create_new'].options.selectedIndex].value; ">
   <option value="" i18n:translate="">-- Create --</option>
   <tal:block tal:repeat="k python:
    sorted ( [k for k in klasses if k [0] in db._db.classes]
           , key = lambda x, y = i18n.gettext : y (x [0]).lower ()
           )">
    <option tal:condition="python:request.user.hasPermission(k [1], k [0])
                                  and k [3]"
            tal:attributes="value python:k[0] + k[2]"
            tal:content="python:i18n.gettext (k[0])" />
   </tal:block>
  </select>
 </span>
</td>

<!-- Macro to display query selector in menu -->
<td metal:define-macro="select_query" class="sidebar" nowrap>
 <span class="classblock">
  <select name="query"
          onChange="javascript:document.location=document.forms['menubar'].elements['query'].options[document.forms['menubar'].elements['query'].options.selectedIndex].value; ">
   <option value="" i18n:translate="">-- View / Query --
   </option>
   <option value="query?@template=edit" i18n:translate="">Manage Queries
   </option>
   <tal:block
    tal:repeat="k python: sorted
        ( [k for k in klasses if k [0] in db._db.classes]
        , key = lambda x, y = i18n.gettext : y (x [3][0] or x [0]).lower ()
        )">
     <tal:block tal:define=
       " name   python: i18n.gettext (k [3][0] or k [0])
       ; klass  python: k [0]
       ; perm   python: k [1]
       ; ok     python: k [2]
       ; tplate python: ('@template=%s&' % k [3][1], '') [not k [3][1]]
       ; qkey   python: k [3][1] or 'index'
       " tal:condition="python:
          (request.user.hasPermission (perm, klass) and ok)">
         <option tal:attributes="value python: '%s?%s%s' %
          ( klass
          , tplate
          , default_queries.get ((klass, k[3][1]), default_query)
          )"
          tal:content="name"/>
         <option tal:define="
            queries python:db.query.filter
             (filterspec = dict
              (private_for = None, klass = klass, tmplate = qkey)
             )"
          tal:repeat="q queries"
          tal:attributes="
           value string:${klass}?@queryname=${q/name}&queryid=${q/id}&${tplate}${q/url}"
          tal:content="structure string:&nbsp;&nbsp;${q/name}"
         >  Global Queries</option>
         <tal:block tal:condition="request/user/queries">
          <option tal:define="
             queries python:[q for q in db.query.filter
              (filterspec = dict
               ( private_for = request.user.id
               , klass       = klass
               , id          = [q.id for q in request.user.queries]
               , tmplate     = qkey
               )
              ) if q.klass == klass]"
           tal:repeat="q queries"
           tal:attributes="
            value
            string:${klass}?@queryname=${q/name}&queryid=${q/id}&${tplate}${q/url}"
           tal:content="structure string:&nbsp;&nbsp;&nbsp;&nbsp;${q/name}"
          >    Private Queries</option>
         </tal:block>
     </tal:block>
   </tal:block>
  </select>
 </span>
</td>

<!-- Macro to display selector for new class and query selector in menu
     This creates the menu items used in Tracker classes as default
-->
<tal:block metal:define-macro="create_or_query_new_tracker_item">
 <tal:block tal:define="menu python:menu_type.get (classname, menu_time)">
  <tal:block tal:define="klasses python: menu [0]">
   <td metal:use-macro="templates/page/macros/create_new" />
  </tal:block>

  <tal:block tal:define="klasses python: menu [1]">
   <td metal:use-macro="templates/page/macros/select_query" />
  </tal:block>
 </tal:block>
</tal:block>

<!-- the following macro is used for all pages which display a
     class that needs some more formatting -->

<td metal:define-macro="formatted_class">
 <span tal:condition="python:not (context.is_view_ok() or context.is_edit_ok())">
 You are not allowed to view this page.
 </span>
 <form method="POST"
       onSubmit="return submit_once()"
       enctype="multipart/form-data"
       tal:attributes="action context/designator; name formname"
       tal:condition="python:context.is_view_ok() or context.is_edit_ok()">

  <input type="hidden" name="@template" value="item">

  <table class="form" border="0" style="border-spacing:0px">
   <tr tal:condition="use_labelprop">
    <th class="required"
     tal:content="structure python:utils.fieldname(classname, labelprop)"/>
    <input tal:condition="python:not context [labelprop].is_edit_ok ()"
     type="hidden" tal:attributes=
      " name  labelprop
      ; value python:context [labelprop]
      ">
    <td colspan="3"
        tal:content="structure python:context [labelprop].field (size=60)"/>
   </tr>
   <tr tal:condition="has_resp">
    <th tal:attributes="class responsible_required | default"
     tal:content="structure python:utils.fieldname(classname, 'responsible')">
    </th>
    <td colspan="3">
     <tal:block tal:define=
        "name      string:responsible;
         form      string:itemSynopsis;
         dont_care python:i18n.gettext ('''- don't care -''');
         selected python:context.responsible and context.responsible.id or 0">
      <tal:block metal:use-macro="templates/userlist/macros/user"/>
     </tal:block>
    </td>
   </tr>

   <tal:block metal:define-slot="formatted_class_content"/>

   <tr tal:condition="has_nosy">
    <th tal:content="structure python:utils.fieldname(classname, 'nosy')"/>
    <td colspan="3">
     <span tal:replace="structure context/nosy/field"/>
     <span tal:condition="context/is_edit_ok"
           tal:replace="structure python:db.user.classhelp
             ( ','.join (n for n in
                         'username,nickname,firstname,lastname'.split(',')
                         if n in db._db.user.properties
                        )
             , property='nosy'
             , width='600'
             , pagesize=500
             , filter='status=%s' % ','.join
               (db._db.user_status.lookup (i) for i in ('valid', 'system'))
             )"/><br>
    </td>
   </tr>

   <tr metal:use-macro="templates/page/macros/message_box"/>

   <tr tal:condition="python:
       has_files and want_files and context.files.is_edit_ok ()">
    <th tal:content="structure python:utils.fieldname(classname, 'files')"/>
    <td colspan="3"><input type="file" name="@file" size="40"/></td>
   </tr>

   <tr tal:condition="context/is_edit_ok">
    <th></th>
    <td colspan="3">
     <tal:block metal:define-slot="button_slot">
         <tal:block tal:replace="structure context/submit"/>
     </tal:block>
     <input tal:condition="context/id"
            type="button" value="Show History"
            i18n:attributes="value"
            tal:attributes="onClick string:javascript:help_window('${context/designator}?@template=history','600','300')">
    </td>
   </tr>
   <tr tal:condition="has_invoices">
    <th style="text-align:left" class="required"
     tal:content="structure python:utils.fieldname(classname, 'invoices')"
     tal:condition="context/invoices" />
   </tr>
   <tal:block tal:repeat="inv context/invoices/reverse"
    tal:condition="has_invoices">
    <tr>
     <th tal:content="structure python:
      utils.fieldname ('invoice','invoice_no')"/>
     <td tal:content="structure python:''.join
         (( utils.ExtProperty
            (utils, inv.invoice_no, item = inv).as_listentry ()
         ,
         ))"/>
     <th tal:content="structure python:
      utils.fieldname ('invoice', 'period', 'period_start')"/>
     <td tal:content="structure python:''.join
         (( utils.ExtProperty
            (utils, inv.period_start, item = inv).as_listentry ()
         , '-'
         ,  utils.ExtProperty
            (utils, inv.period_end,   item = inv).as_listentry ()
         ))"/>
    </tr>
   </tal:block>
   <tr tal:condition="python:has_letters and context.letters">
    <th style="text-align:left" class="required"
     tal:content="structure python:utils.fieldname (classname, 'letters')"/>
   </tr>
   <tal:block tal:repeat="ltr context/letters/reverse"
    tal:condition="has_letters">
    <tr>
     <th tal:content="structure python:utils.fieldname ('letter','period')"/>
     <td tal:content="structure python:''.join
         (( utils.ExtProperty
            (utils, ltr.date, item = ltr, is_labelprop = 1).as_listentry ()
          , '&nbsp;'
          , '--'
          , '&nbsp;'
          , utils.letter_link (request, ltr.id)
         ))"/>
     <th tal:content="structure python:utils.fieldname ('letter', 'subject')"/>
     <td tal:content="structure python:''.join
         ((  utils.ExtProperty
            (utils, ltr.subject, item = ltr).as_listentry ()
          ,
         ))"/>
    </tr>
   </tal:block>
  </table>
  <p tal:condition="context/id" i18n:translate="">
   Created on
   <b i18n:name="creation" tal:content="python:context.creation.pretty
      (utils.ymd)"/> by
   <b i18n:name="creator"  tal:content="context/creator"/>, last changed
   <b i18n:name="activity" tal:content="python:context.activity.pretty
      (utils.ymd)"/> by
   <b i18n:name="actor"    tal:content="context/actor"/>.
  </p>
  <input type="hidden" name="@required"
         tal:attributes="value required_attributes | labelprop">

 </form>

 <table metal:use-macro="templates/page/macros/note_required" />
 <table metal:use-macro="templates/page/macros/message_display" />
 <table class="files" tal:condition="python:
        has_files and context.files and context.files.is_view_ok ()">
  <tr>
   <th colspan="3" class="header">Files</th>
  </tr>
  <tr>
   <td colspan="3">
    <tal:block metal:use-macro="templates/page/macros/file_list"/>
   </td>
  </tr>
 </table>
</td>

<tal:block metal:define-macro="message_box">
  <tr tal:condition="python:context.is_edit_ok () and has_msgs">
   <th tal:content="structure python:utils.fieldname(classname,'msg')" />
   <td colspan="3">
    <textarea tal:content="request/form/@note/value | default"
              tal:attributes="rows msg_box_height"
              name="@note"
              wrap="hard"
              cols="80"/>
   </td>
  </tr>
</tal:block>

<tal:block metal:define-macro="note_required">
 <table class="form" tal:condition="python:
        not context.id and context.is_edit_ok ()">
 <tr>
  <td i18n:translate="">Note:&nbsp;</td>
  <th class="required" i18n:translate="">highlighted</th>
  <td i18n:translate="">&nbsp;fields are required.</td>
 </tr>
 </table>
</tal:block>

<tal:block metal:define-macro="message_display">
 <table class="messages" tal:condition="python:
  has_msgs and context.messages and context.is_view_ok ()">
  <tr>
   <th colspan="4" class="header" tal:content="structure python:
     utils.fieldname (classname, 'messages')"/>
  </tr>
  <tal:block tal:repeat="msg context/messages/reverse">
  <tr>
   <th><a tal:attributes="href string:msg${msg/id}"
          tal:content="string:msg${msg/id}"></a></th>
   <th>
    <tal:block i18n:translate="">Author:</tal:block>
    <a tal:attributes="href string:user${msg/author/id}"
       tal:content="msg/author"/>
   </th>
   <th>
    <tal:block i18n:translate="">Date:</tal:block>
    <tal:block tal:content="msg/date"/>
   </th>
   <th>
    <a i18n:translate="" tal:condition="may_remove_msgs" tal:attributes="href
       string:${classname}${context/id}?remove:messages=${msg/id}&:action=edit">
     remove
    </a>
   </th>
<!--
   <th>
    <form style="padding:0" tal:condition="context/is_edit_ok"
          tal:attributes="action string:issue${context/id}">
     <input type="hidden" name="@remove@messages" tal:attributes="value msg/id">
     <input type="hidden" name="@action" value="edit">
     <input type="submit" value="remove">
    </form>
   </th>
-->
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre tal:content="structure msg/content/hyperlinked">content</pre>
   </td>
  </tr>
  </tal:block>
 </table>
</tal:block>

<!-- list links to a group of items -->
<!-- needs items and klassname set up -->
<!-- klassname should be the name of the klass, is used for the style class -->
<!-- each item should be a HTMLItem with the following properties: -->
<!-- status/name, status/abbreviation, title, responsible -->
<!-- status should map a ${klassname}_${item/status}_${postfix} a.href class in style.css -->
<!--   where postfix will be "${item/test_ok|nothing}" -->
<tal:block metal:define-macro="task_list">
 <tal:block tal:repeat="item items"
            tal:define="postfix item/test_ok|python:''">
  <a tal:attributes="href item/designator;
                     class string:${klassname}_${item/status}_${postfix}"
     tal:content="structure string:<code>${item/designator} (${item/status/abbreviation}, ${item/responsible/nickname}):</code> ${item/title}"></a><br>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="simple_list">
 <tal:block tal:repeat="item items">
  <a tal:attributes="href item/designator;
                     class string:${klassname}_${item/status}"
     tal:content="structure string:<code>${item/designator} (${item/status}, ${item/responsible/nickname}):</code> ${item/title}"></a><br>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="file_list">
 <!-- list of files -->
 <table class="files" tal:condition="context/files">
  <tr>
   <th>File name</th>
   <th>Uploaded</th>
   <th>Type</th>
  </tr>
  <tr tal:repeat="file context/files">
   <td>
    <a tal:attributes="href file/download_url"
       tal:content="file/name">dld link</a>
   </td>
   <td>
    <span tal:content="file/creator">creator's name</span>,
    <span tal:content="file/creation">creation date</span>
   </td>
   <td tal:content="file/type" />
  </tr>
 </table>
</tal:block>

<!-- the following lists a nice list of files plus file upload form -->
<tal:block metal:define-macro="formatted_class_files">
 <tal:block metal:use-macro="templates/page/macros/file_list"/>
 <input type="file" name="@file" size="40">
</tal:block>

<!-- the following is used to have those nifty index/search form on one page -->
<!-- the caller needs to define a list of tuples for the properties: -->
<!--  props = (("<name to display>", "<designator>"), ...) -->

<tal:block metal:define-macro="search_nav">
<!-- previous / next links -->
   <tr>
    <th tal:attributes="colspan python:len(request.columns)">
     <table width="100%">
      <tr class="navigation">
       <th class="left">
        <a tal:define="prev batch/previous" tal:condition="prev"
           i18n:translate=""
           tal:attributes="href python:
               str ( request.indexargs_href
                     ( request.classname
                     , {':startwith':prev.first, ':pagesize':prev.size}
                     )
                   )">
           &lt;&lt;&nbsp;previous
        </a>
       </th>
       <th tal:condition="batch/sequence_length">
        <nobr i18n:translate="">
            showing <span tal:replace="batch/start" i18n:name="start"/>
            - <span tal:replace="python:batch.start + batch.length -1"
                    i18n:name="end"/>
            of <span tal:replace="batch/sequence_length" i18n:name="length"/>
            in total
        </nobr>
       </th>
       <th tal:condition="not:batch/sequence_length">
        <nobr i18n:translate="">
        Sorry, no results found
        </nobr>
       </th>
       <th class="right">
        <a tal:define="next batch/next" tal:condition="next"
           i18n:translate=""
           tal:attributes="href python:
               str ( request.indexargs_href
                     ( request.classname
                     , {':startwith':next.first, ':pagesize':next.size}
                   )
                  )">
           next&nbsp;&gt;&gt;
        </a>
       </th>
      </tr>
     </table>
    </th>
   </tr>
</tal:block>

<!--
 the next two search_results and simple_search_form needs the following
 variables set up as follows:
 props: a tuple (or list) of ExtProperty objects. See extensions/extproperty.py
-->

<!-- display the search results -->
<tal:block metal:define-macro="search_results">
 <tal:block tal:condition="not:quiet">
  <tal:block tal:condition="not:context/is_view_ok">
   You are not allowed to view this page.
  </tal:block>

  <tal:block tal:define="batch request/batch"
             tal:condition="context/is_view_ok">
   <table class="list" border=1>
    <tr>
     <!-- list all properties we want to see -->
     <tal:block tal:repeat="prop props">
      <th tal:condition="python:request.show[prop.searchname]"
          tal:content="python:prop.i18nlabel"/>
     </tal:block>
    </tr>
    <tal:block metal:use-macro="templates/page/macros/search_nav"/>
    <!-- items found -->
    <tal:block tal:repeat="i batch">
     <tr tal:condition="python:
       request.group and batch.propchanged(*[g[1] for g in request.group])">
      <th tal:attributes="colspan python:len(request.columns)" class="group">
       <tal:block tal:repeat="gr request/group">
        <tal:block tal:content="python:i[gr[1]]"/>
       </tal:block>
      </th>
     </tr>
     <tr tal:attributes="class python:['normal', 'alt'][repeat['i'].index%2]">
      <!-- all the properties: label property and id will be made a link -->
      <!-- filter out only the properties the user wants to see -->
      <tal:block tal:repeat="prop props">
       <td tal:condition="python:request.show [prop.searchname]"
           tal:content="structure python:prop.as_listentry (i)"
           tal:attributes="class python:prop.get_cssclass(i)">
       </td>
      </tal:block>
     </tr>
    </tal:block> <!-- repeat i batch -->
   </table>
  </tal:block>
 </tal:block>
</tal:block>

<tal:block metal:define-macro="simple_search_form">
 <tal:block tal:define=
     " multi_props    python: [p for p in props if p.multiselect]
     ; sort_props     python: [p for p in props if p.sortable]
     ; nomulti_props  python: [p for p in props
                               if (not p.multiselect and p.searchable)]
     ; csv_link       python:request.indexargs_url
            (classname, {'@action':'export_csv_names'})
     ; do_fulltext    python: not terse
     ; do_pagesize    python: True
     ; props          python: [p for p in props if p.displayable]
     ">
  <tal:block metal:use-macro="templates/page/macros/search_form"/>
 </tal:block>
</tal:block>

<!-- needs terse, props, multi_props, sort_props, nomulti_props, csv_link -->
<tal:block metal:define-macro="search_form">
 <!-- query specification form -->
 <form method="GET" name="query" tal:attributes="action request/classname">
  <tal:block metal:define-slot="search_variables"/>
  <input type="hidden" name=":action" value="searchwithtemplate">
  <input type="hidden" name=":startwith"
   tal:attributes="value request/startwith">
  <input type="hidden" name=":template"
   tal:attributes="value python:request.template or 'index'">
  <table border="0" bgcolor="#e0c0c0" class="searchform">
   <tr>
    <th bgcolor="#C08080" i18n:translate="" colspan="5">
     <span i18n:translate="">Query</span>
     <span tal:replace="head_title" i18n:name="title"/>
    </th>
   </tr>

   <tr tal:condition="not:terse">
    <td tal:condition="do_pagesize" colspan="2">
     <span i18n:translate="">View</span>
     <input type="text" size="4" name=":pagesize"
            tal:attributes="value request/pagesize">
     <span i18n:translate="">items per page</span>
    </td>
    <td/>
    <td style="text-align:right;" colspan="2">
     <a tal:attributes="href csv_link" i18n:translate="">Download as CSV</a>
    </td>
   </tr>
   <input type="hidden" tal:condition="terse" name=":pagesize"
          tal:attributes="value request/pagesize">
   <tal:block tal:repeat="onum python:range(n_sort)"
    tal:condition="python:sort_props">
    <tal:block tal:define=
        "skey python:(len(request.sort) >onum or '') and request.sort [onum]
        ;gkey python:(len(request.group)>onum or '') and request.group[onum]
        ">
     <tal:block tal:condition="terse">
      <input type="hidden" tal:attributes=
             " name python:':sort%d'%onum
             ; value python:''.join ([k,''][k=='+'] for k in skey)
             ">
      <input type="hidden" tal:attributes=
             " name python:':group%d'%onum
             ; value python:''.join ([k,''][k=='+'] for k in gkey)
             ">
     </tal:block>
     <tr tal:condition="not:terse">
      <td nowrap>
       <tal:block tal:condition="not:onum" i18n:translate="">
           Sort on:
       </tal:block>
      </td>
      <td nowrap>
       <select tal:attributes="name python:':sort%d'%onum"
        onChange="this.form.elements[':startwith'].value='0'">
        <option value="" i18n:translate="">- nothing -</option>
        <option tal:repeat="prop sort_props"
         tal:attributes= "selected python:skey and prop.searchname==skey[1];
                          value    python:prop.searchname"
         tal:content="python:prop.i18nlabel"/>
       </select>
       <span i18n:translate="">Descending:</span>
       <input type="checkbox"
        tal:attributes="name python:':sortdir%d'%onum
                       ;checked python:skey and skey[0] == '-'
                       "
        onChange="this.form.elements[':startwith'].value='0'"/>
      </td>
      <td nowrap>&nbsp;</td>
      <td nowrap>
       <tal:block tal:condition="not:onum" i18n:translate="">
           Group on:
       </tal:block>
      </td>
      <td nowrap>
       <select tal:attributes="name python:':group%d'%onum"
        onChange="this.form.elements[':startwith'].value='0'">
        <option value="" i18n:translate="">- nothing -</option>
        <option tal:repeat="prop sort_props"
         tal:attributes= "selected python:gkey and prop.searchname==gkey[1];
                          value    python:prop.searchname"
         tal:content="python:prop.i18nlabel"/>
       </select>
       <span i18n:translate="">Descending:</span>
       <input type="checkbox"
        tal:attributes="name python:':groupdir%d'%onum
                       ;checked python:gkey and gkey[0] == '-'
                       "
        onChange="this.form.elements[':startwith'].value='0'"/>
      </td>
     </tr>
    </tal:block>
   </tal:block>
   <tr>
    <td colspan="5">
     <table border="0" bgcolor="#e0c0c0" align="left" class="searchform"
      tal:condition="python:props and not terse">
      <tr>
       <th style="text-align:left;" tal:content="structure python:
         utils.fieldname (classname, 'VIEW', endswith=':', csscls='header')"/>
      </tr>
      <tr>
       <!-- View -->
       <td style="text-align:center;">
        <select multiple name=":columns" size="7">
         <option tal:repeat="prop props"
                 tal:attributes="selected python:request.show[prop.searchname];
                                 value    python:prop.searchname"
                 tal:content="python:prop.i18nlabel"/>
        </select>
       </td>
      </tr>
     </table>
     <input tal:condition="terse" type="hidden" name=":columns"
            tal:attributes="value python:','.join(request.show.keys)">
     <tal:block tal:repeat="prop multi_props">
      <input tal:condition="python:terse and not prop.terse"
             type="hidden" tal:attributes=
             " name  python:prop.searchname
             ; value python:
                     ','.join(request.filterspec.get(prop.searchname) or [])
             ">
      <table border="0" bgcolor="#e0c0c0" align="left" class="searchform"
             tal:condition="python:not terse or prop.terse">
       <tr>
        <th style="text-align:left;"
         tal:content="structure python:prop.colonlabel()"/>
       </tr>
       <tr>
        <td style="text-align:center;">
         <tal:block tal:condition="python:
          prop.lnkcls == 'user' and prop.searchname != 'nosy'"
          tal:define=
           "size      string:7;
            name      python:prop.searchname;
            form      string:query;
            dont_care python:i18n.gettext ('''- don't care -''');
            selected  python:
             str(request.filterspec.get(prop.searchname) or [''])[1:-1]
           ">
          <tal:block metal:use-macro="templates/userlist/macros/user_multi_read"/>
         </tal:block>
         <tal:block tal:condition="python:prop.searchname == 'nosy'"
          tal:define=
           "size      string:7;
            name      python:prop.searchname;
            form      string:query;
            dont_care python:i18n.gettext ('''- don't care -''');
            selected  python:
             str(request.filterspec.get(prop.searchname) or [''])[1:-1]
           ">
          <tal:block metal:use-macro="templates/userlist/macros/nosy_multi"/>
         </tal:block>
         <tal:block tal:condition="python:prop.lnkcls != 'user'">
          <select multiple
                  size="7"
                  tal:attributes="name python:prop.searchname"
                  tal:define="form_vals
                    python:request.filterspec.get(prop.searchname) or []">
           <option value="" i18n:translate="" tal:attributes=
            "selected not:form_vals">- don't care -</option>
           <option value="-1" i18n:translate=""
            tal:condition="python: not prop.leafprop.required"
            tal:attributes="selected python:'-1' in form_vals"
           >- not selected -</option>
           <option
            tal:repeat="s python: db[prop.lnkcls.classname].filter
                ( filterspec = prop.filter
                , group      = [('+', prop.lnkcls.orderprop ())]
                )"
            tal:attributes=
                "value    s/id;
                 selected python:s.id in form_vals"
            tal:content="python:s[prop.propname]">
           </option>
          </select>
         </tal:block>
        </td>
       </tr>
      </table>
     </tal:block>
    </td>
   </tr>

   <tr>
    <td colspan="5">
     <table border="0" bgcolor="#e0c0c0">
      <!-- fill in text entry fields -->
      <tal:block tal:repeat="prop nomulti_props">
       <input tal:condition="python:terse and not prop.terse"
              type="hidden" tal:attributes=
              " name  python:prop.searchname
              ; value python:
                      ','.join(request.filterspec.get(prop.searchname) or [])
              ">
       <tr tal:condition="python:not terse or prop.terse">
        <th style="text-align:right;"
            tal:content="structure python:prop.colonlabel()"/>
        <td>
         <tal:block tal:replace="structure python:prop.search_input (request)"/>
         <span tal:condition="python:prop.do_classhelp"
           tal:replace="structure python:db[prop.lnkcls.classname].classhelp
            ( properties=prop.classhelp_properties
              ('description', 'status', 'responsible')
            , property=prop.searchname
            , form='query'
            , pagesize=500
            , filter=prop.help_filter
            , sort=prop.help_sort
            )"/>
        </td>
       </tr>
      </tal:block>
      <tr tal:condition="do_fulltext">
       <th style="text-align:right;" i18n:translate="">Search full text:</th>
       <td>
        <input type="text" size="40" name=":search_text"
         onChange="this.form.elements[':startwith'].value='0'"
         tal:attributes="value request/form/:search_text/value | nothing">
        <span i18n:translate="">(Searches also in messages)</span>
       </td>
      </tr>
      <!-- submit button -->
      <tr>
       <th/>
       <td>
        <input type="submit" i18n:attributes="value" value="Update view"
         onClick="document.forms ['query'].elements ['@queryname'].value = '';
                  document.forms ['query'].elements ['new_query'].value = '';
                  document.forms ['query'].elements ['queryid'].value = '';"
         tal:condition="not:terse">
        <input type="submit" i18n:attributes="value" value="Find"
         onClick="document.forms ['query'].elements ['@queryname'].value = '';
                  document.forms ['query'].elements ['new_query'].value = '';
                  document.forms ['query'].elements ['queryid'].value = '';"
         tal:condition="terse">
       </td>
      </tr>
      <tr tal:define="
        queryid   request/form/queryid/value | nothing;
        new_query request/form/new_query/value | nothing;
        u_q       python:sorted ([q.id for q in request.user.queries]);
        " tal:condition="not:terse">
       <th style="text-align:right;" i18n:translate="">This query's name:</th>
       <td tal:define="queryid python:
           new_query and (u_q and u_q.pop()) or queryid">
        <input type="hidden" name="queryid"
               tal:attributes="value queryid | nothing">
         <span tal:condition="python:
               queryid and queryid in request.user.queries">
          <input type="hidden" name="@queryname">
          <input type="hidden" name="@old-queryname">
          <input type="text"
                name="_queryname"
                tal:attributes="value request/form/@queryname/value | default">
          <input type="submit" i18n:attributes="value"
           value="Update view & store this query"
           onClick="document.forms ['query'].elements ['@queryname'].value =
                    document.forms ['query'].elements ['_queryname'].value;
                    document.forms ['query'].elements ['@old-queryname'].value =
                    document.forms ['query'].elements ['_queryname'].value;
                    ">
          <span i18n:translate="">
            (If you change the name, you create a new query!!!)
          </span>
         </span>
         <span tal:condition="python:
               not queryid or queryid not in request.user.queries">
          <input type="text" name="@queryname" onChange=
            "document.forms ['query'].elements ['new_query'].value = '1';">
          <input type="hidden" name="new_query" value="">
          <input type="submit" i18n:attributes="value"
                 value="Update view & store NEW query">
         </span>
       </td>
      </tr>
     </table>
    </td>
   </tr>
  </table>
 </form>
</tal:block>

<!-- needed vars: property: Multilink to address, button_text -->
<tal:block metal:define-macro="address_list">
 <tr>
  <th tal:content="structure python:utils.fieldname (classname, property)"/>
  <td colspan="3">
   <table class="form" border="0"
          style="border-spacing:0px;padding-top:0px;padding-left:0px">
    <tr>
     <th style="text-align:left;padding-top:0px">
      <span tal:content="structure python:utils.fieldname
         ('address', 'firstname')"/>
      /
      <span tal:content="structure python:utils.fieldname
         ('address', 'lastname')"/>
      /
      <span tal:content="structure python:utils.fieldname
         ('address', 'function')"/>
     <th style="text-align:left;padding-top:0px"
         tal:condition="context/is_edit_ok" i18n:translate=""
         style="padding-top:0px">
         remove
     </th>
    </tr>
    <tr tal:repeat="ca python:sorted
        ( context [property]
        , key = lambda x : (x.firstname, x.lastname, x.function)
        )">
     <td>
      <span>
       <a i18n:translate="" tal:attributes="href python:
          'address%s' % ca.id">
        <span nowrap
         tal:content="python: ' '.join
          (( ca.firstname.plain ()
          ,  ca.lastname.plain ()
          ))"/>
        <span nowrap
         tal:content="python: ' '.join
          (ca.function.plain ().split ('\n')[:1])"/>
       </a>
      </span>
     </td>
     <td tal:condition="context/is_edit_ok">
      <input type="checkbox" tal:attributes="
                 value ca/id;
                 name  string:@remove@${property};">
     </td>
    </tr>
    <tr>
     <td colspan="2">
      <span>
       <input type="text" size="6" tal:attributes="
        onchange string:document.forms.itemSynopsis ['@link@${property}'].value
          = 'address' + document.forms.itemSynopsis.a_${property}.value;
        name string:a_${property}">
       <input type="hidden" tal:attributes="name string:@link@${property}">
       <input tal:condition="context/shipping_address"
         type="button" tal:attributes=
          "onClick python:'javascript:document.location = '
           '\'%s?@attr=%s&@frm=shipping_address&@action=create_new_address\''
           % (context.designator (), property)
          ; value python:utils.adress_button ('shipping_address', property)
          ">
      </span>
     </td>
     <td>
       <input tal:condition="context/invoice_address"
         type="button" tal:attributes=
          "onClick python:'javascript:document.location = '
           '\'%s?@attr=%s&@frm=invoice_address&@action=create_new_address\''
           % (context.designator (), property)
          ; value python:utils.adress_button ('invoice_address', property)
          ">
     </td>
    </tr>
   </table>
  </td>
 </tr>
</tal:block>
